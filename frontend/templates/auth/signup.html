{% extends 'base/base.html' %}
{% load static %}

{% block title %}회원가입 | MeetAgain{% endblock %}

{% block extra_head %}
<style>
  * {
    box-sizing: border-box;
    font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
  }

  body {
    background: #f4f5fa;
  }

  .logo {
    font-size: 28px;
    font-weight: bold;
    color: #6A5ACD;
    text-align: center;
    margin-top: 60px;
  }

  .signup-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    padding: 32px;
    width: 360px;
    margin: 20px auto;
  }

  .signup-card h2 {
    margin-bottom: 24px;
    font-size: 24px;
    color: #6A5ACD;
    text-align: center;
  }

  label {
    display: block;
    margin: 12px 0 4px;
    font-weight: bold;
    font-size: 14px;
  }

  input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
  }

  .email-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 8px;
    align-items: center;
  }

  .email-domain {
    padding: 10px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
  }

  #send-code {
    margin-top: 8px;
    background-color: #6A5ACD;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
  }

  #send-code:disabled {
    background-color: #999;
    cursor: default;
  }

  #send-code:hover:enabled {
    background-color: #5548c8;
  }

  #timer {
    display: none;
    margin-top: 8px;
    color: #888;
    font-size: 13px;
  }

  .auth-code-wrapper {
    display: flex;
    gap: 8px;
    margin-top: 4px;
  }

  .auth-code-wrapper input {
    flex: 1;
  }

  #verify-code {
    background-color: #6A5ACD;
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
  }

  #verify-result {
    font-size: 13px;
    margin-top: 6px;
  }

  #signup-btn {
    margin-top: 16px;
    background-color: #6A5ACD;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
    font-weight: bold;
  }

  #signup-btn:hover {
    background-color: #5548c8;
  }

  .sr-only-field {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }
</style>
{% endblock %}

{% block content %}
<div class="logo">MeetAgain</div>
<div class="signup-card">
  <h2>회원가입</h2>
  <form method="POST" action="{% url 'users:signup' %}" id="signup-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- 이메일: 로컬파트만 입력 + 도메인 고정 -->
    <label for="email_local">학번 (이메일)</label>
    <div class="email-row">
      <input type="text" id="email_local" placeholder="학번" autocomplete="username" inputmode="email" maxlength="64" />
      <div class="email-domain">@sungshin.ac.kr</div>
    </div>
    <div class="sr-only-field">
      {{ form.email }}
    </div>

    <button type="button" id="send-code">인증번호 발송</button>
    <span id="timer">03:00</span>

    <div id="auth-code-field" style="display: none;">
      <label for="{{ form.auth_code.id_for_label }}">인증번호</label>
      <div class="auth-code-wrapper">
        {{ form.auth_code }}
        <button type="button" id="verify-code">확인</button>
      </div>
      <p id="verify-result"></p>
    </div>

    <label for="{{ form.student_id.id_for_label }}">학번</label>
    {{ form.student_id }}

    <label for="{{ form.password1.id_for_label }}">비밀번호</label>
    {{ form.password1 }}
    <label for="{{ form.password2.id_for_label }}">비밀번호 확인</label>
    {{ form.password2 }}

    <button type="submit" id="signup-btn">가입하기</button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const DOMAIN = "sungshin.ac.kr";

    const form = document.getElementById("signup-form");
    const emailLocal = document.getElementById("email_local");
    const hiddenEmail = document.getElementById("id_email");
    const sendCodeBtn = document.getElementById("send-code");
    const timerDisplay = document.getElementById("timer");
    const authCodeField = document.getElementById("auth-code-field");
    const verifyBtn = document.getElementById("verify-code");
    const resultText = document.getElementById("verify-result");
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    function sanitizeLocalPart(value) {
      return value.replace(/\s+/g, "").replace(/@/g, "");
    }

    function buildEmail() {
      const local = sanitizeLocalPart(emailLocal.value.trim());
      const email = local ? `${local}@${DOMAIN}` : "";
      hiddenEmail.value = email;
      return email;
    }

    emailLocal.addEventListener("input", () => {
      const before = emailLocal.value;
      const after = sanitizeLocalPart(before);
      if (before !== after) emailLocal.value = after;
      buildEmail();
    });

    emailLocal.addEventListener("blur", buildEmail);

    form.addEventListener("submit", (e) => {
      const email = buildEmail();
      if (!email) {
        e.preventDefault();
        alert("이메일(학번)을 입력해주세요.");
        return;
      }
      const pattern = new RegExp(`^[^@\\s]+@${DOMAIN.replace('.', '\\.')}$`, "i");
      if (!pattern.test(email)) {
        e.preventDefault();
        alert("이메일 형식이 올바르지 않습니다.");
        return;
      }
    });

    function startTimer(duration) {
      let time = duration;
      timerDisplay.style.display = "inline";
      sendCodeBtn.disabled = true;
      const interval = setInterval(() => {
        const minutes = String(Math.floor(time / 60)).padStart(2, "0");
        const seconds = String(time % 60).padStart(2, "0");
        timerDisplay.textContent = `${minutes}:${seconds}`;
        if (--time < 0) {
          clearInterval(interval);
          timerDisplay.textContent = "시간 만료";
          sendCodeBtn.disabled = false;
        }
      }, 1000);
    }

    sendCodeBtn.addEventListener("click", () => {
      const email = buildEmail();
      if (!email) {
        alert("이메일(학번)을 입력해주세요.");
        return;
      }
      fetch("/users/send-signup-code/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ email }),
      })
        .then((res) => { if (!res.ok) throw new Error("HTTP " + res.status); return res.json(); })
        .then((data) => {
          if (data.success) {
            authCodeField.style.display = "block";
            resultText.textContent = "";
            startTimer(180);
          } else {
            alert("인증번호 전송 실패");
          }
        })
        .catch((err) => { alert("❌ 인증번호 요청 실패: " + err); });
    });

    verifyBtn.addEventListener("click", () => {
      const email = buildEmail();
      const code = document.getElementById("id_auth_code").value.trim();

      if (!email || !code) {
        alert("이메일과 인증번호를 모두 입력해주세요.");
        return;
      }

      fetch("/users/verify-signup-code/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ email, code }),
      })
        .then((res) => { if (!res.ok) throw new Error("HTTP " + res.status); return res.json(); })
        .then((data) => {
          if (data.success) {
            resultText.textContent = "✅ 인증에 성공했습니다.";
            resultText.style.color = "green";
            document.getElementById("id_auth_code").value = "";
            const local = email.split("@")[0];
            const sid = document.getElementById("id_student_id");
            if (sid) sid.value = local;
          } else {
            resultText.textContent = "❌ 인증번호가 올바르지 않거나 만료되었습니다.";
            resultText.style.color = "red";
            document.getElementById("id_auth_code").value = "";
          }
        })
        .catch((err) => {
          resultText.textContent = "❌ 서버 오류가 발생했습니다.";
          resultText.style.color = "red";
          console.error(err);
        });
    });

    buildEmail();
  });
</script>
{% endblock %}