{% extends 'base/base.html' %}
{% load static %}

{% block title %}MeetAgain - 비밀번호 재설정{% endblock %}

{% block extra_head %}
<style>
  * { box-sizing: border-box; font-family: 'Segoe UI','Noto Sans KR',sans-serif; }
  html, body { height: 100%; margin: 0; padding: 0; background: #f4f5fa; }

  .login-page-wrapper { display:flex; flex-direction:column; justify-content:center; align-items:center; height:calc(100vh - 4rem); }
  .logo { font-size:28px; font-weight:bold; color:#6A5ACD; margin-bottom:20px; }
  .login-card { background:#fff; border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,.1); padding:32px; width:360px; }
  .login-card h2 { margin-bottom:24px; font-size:24px; color:#6A5ACD; text-align:center; }

  label { display:block; margin:12px 0 4px; font-weight:bold; font-size:14px; text-align:left; }
  input { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }

  .links { margin-top:12px; font-size:13px; text-align:center; }
  .links a { color:#6A5ACD; text-decoration:none; margin:0 6px; }
  .links a:hover { text-decoration:underline; }

  .btn-primary { margin-top:20px; width:100%; padding:12px; background:#6A5ACD; color:#fff; border:0; border-radius:6px; font-size:15px; font-weight:bold; cursor:pointer; }
  .btn-primary:hover { background:#5548c8; }
  .btn-primary:disabled { opacity:.55; cursor:not-allowed; }
  .btn-row { display:flex; gap:10px; margin-top:12px; }
  .btn-secondary, .btn-ghost { flex:1; padding:10px; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer; }
  .btn-secondary { background:#6A5ACD; color:#fff; border:0; }
  .btn-secondary:hover { background:#5548c8; }
  .btn-ghost { background:#fff; color:#6A5ACD; border:1px solid #6A5ACD; }
  .btn-ghost:hover { background:#f3f1ff; }

  #timer { font-size:13px; color:#888; text-align:right; margin-top:6px; margin-bottom:0; }
  #verify-result { font-size:13px; margin-top:6px; margin-bottom:10px; text-align:left; display:block; }

  /* 이메일 로컬+도메인 고정 UI */
  .email-input { display:flex; align-items:center; }
  #email_local { flex:1; padding:10px; border:1px solid #ccc; border-right:0; border-radius:6px 0 0 6px; font-size:14px; }
  .email-domain { padding:10px 12px; border:1px solid #ccc; border-left:0; border-radius:0 6px 6px 0; background:#f3f4ff; color:#555; font-size:14px; }
</style>
{% endblock %}

{% block content %}
<div class="login-page-wrapper">
  <div class="logo">MeetAgain</div>

  <div class="login-card">
    <h2>비밀번호 변경</h2>

    {% if messages %}
      <ul class="alert alert-danger">
        {% for message in messages %}<li>{{ message }}</li>{% endfor %}
      </ul>
    {% endif %}

    <form method="POST" action="{% url 'users:password_reset' %}">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- 이메일: 로컬만 입력 + @sungshin.ac.kr 고정 -->
      <label for="email_local">이메일</label>
      <div class="email-input">
        <input type="text" id="email_local"
               placeholder="학번 또는 아이디"
               value="{% if form.email.value %}{{ form.email.value|cut:'@sungshin.ac.kr' }}{% endif %}"
               required>
        <span class="email-domain">@sungshin.ac.kr</span>
        <input type="hidden" name="email" id="id_email"
               value="{% if form.email.value %}{{ form.email.value }}{% endif %}">
      </div>
      {{ form.email.errors }}

      {% if step == 'email' %}
        <button type="submit" name="send_code" class="btn-primary">인증번호 전송</button>
      {% endif %}

      {% if step == 'code' or step == 'password' %}
        <label for="{{ form.auth_code.id_for_label }}">인증번호</label>
        {{ form.auth_code }}
        <div id="timer">03:00</div>
        <p id="verify-result"></p>

        {% if step == 'code' %}
          <div class="btn-row">
            <button type="button" id="verify-code" class="btn-secondary">인증번호 확인</button>
            <button type="submit" name="send_code" class="btn-ghost">재전송</button>
          </div>
        {% endif %}

        <!-- ⬇️ 비밀번호 입력칸이 들어올 자리 (AJAX 성공 시 동적 삽입) -->
        <div id="pw-area">
          {% if step == 'password' %}
            <label for="{{ form.new_password.id_for_label }}">새 비밀번호</label>
            {{ form.new_password }}
            <label for="{{ form.confirm_password.id_for_label }}">비밀번호 확인</label>
            {{ form.confirm_password }}
            <button type="submit" name="reset_password" class="btn-primary">비밀번호 재설정</button>
          {% endif %}
        </div>
      {% endif %}
    </form>

    <div class="links">
      <a href="{% url 'users:login' %}">← 로그인으로 돌아가기</a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // 이메일 로컬 -> 숨은 full email 동기화
  (function(){
    const localPart = document.getElementById('email_local');
    const fullEmail = document.getElementById('id_email');
    function syncEmail(){
      const v = (localPart.value || '').trim();
      fullEmail.value = v ? (v + '@sungshin.ac.kr') : '';
    }
    if (localPart && fullEmail) {
      localPart.addEventListener('input', syncEmail);
      syncEmail();
    }
  })();
</script>

{% if step == 'code' %}
<script>
  // 타이머
  const timerDisplay = document.getElementById("timer");
  let time = 180;
  const timer = setInterval(() => {
    const min = String(Math.floor(time / 60)).padStart(2, "0");
    const sec = String(time % 60).padStart(2, "0");
    timerDisplay.textContent = `${min}:${sec}`;
    if (--time < 0) { clearInterval(timer); timerDisplay.textContent = "시간 만료"; }
  }, 1000);

  // 인증번호 확인 (AJAX) -> 성공 시 비번칸 동적 삽입
  const verifyBtn = document.getElementById("verify-code");
  verifyBtn.addEventListener("click", () => {
    const email = document.getElementById("id_email").value.trim();
    const code = document.getElementById("id_auth_code").value.trim();
    const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;
    const result = document.getElementById("verify-result");

    if (!email || !code) {
      result.textContent = "이메일과 인증번호를 입력해주세요.";
      result.style.color = "red";
      return;
    }

    fetch("/users/verify-reset-code/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf },
      body: new URLSearchParams({ email, code }),
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        result.textContent = "✅ 인증에 성공했습니다.";
        result.style.color = "green";

        // 인증 UI 잠금
        verifyBtn.disabled = true;
        const codeInput = document.getElementById("id_auth_code");
        if (codeInput) codeInput.readOnly = true;
        if (timerDisplay) timerDisplay.style.display = "none";

        // 비밀번호 입력칸 삽입 (중복 방지)
        const pwArea = document.getElementById("pw-area");
        if (pwArea && !document.getElementById("id_new_password")) {
          pwArea.innerHTML = `
            <label for="id_new_password">새 비밀번호</label>
            <input type="password" name="new_password" id="id_new_password" required>

            <label for="id_confirm_password">비밀번호 확인</label>
            <input type="password" name="confirm_password" id="id_confirm_password" required>

            <button type="submit" name="reset_password" class="btn-primary" disabled>비밀번호 재설정</button>
          `;

          // 두 칸 일치해야 버튼 활성화
          const np = document.getElementById("id_new_password");
          const cp = document.getElementById("id_confirm_password");
          const submitBtn = pwArea.querySelector('button[name="reset_password"]');
          const toggle = () => { submitBtn.disabled = !(np.value && cp.value && np.value === cp.value); };
          np.addEventListener("input", toggle);
          cp.addEventListener("input", toggle);
          toggle();

          pwArea.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      } else {
        result.textContent = "❌ 인증번호가 올바르지 않거나 만료되었습니다.";
        result.style.color = "red";
      }
    })
    .catch(() => {
      result.textContent = "❌ 서버 오류가 발생했습니다.";
      result.style.color = "red";
    });
  });
</script>
{% endif %}
{% endblock %}
