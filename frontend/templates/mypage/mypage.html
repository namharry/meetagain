{% extends 'base/base.html' %}
{% block content %}
<div class="container mt-5 mb-5" style="max-width: 700px;">
  <h2 class="mb-4">마이페이지</h2>

  <!-- 내 정보 -->
  <div class="card mb-4">
    <div class="card-header">내 정보</div>
    <div class="card-body">
      <p><strong>이름:</strong> {{ user.username }}</p>
      <p><strong>학번:</strong> {{ user.profile.student_id }}</p>
      <p><strong>이메일:</strong> {{ user.email }}</p>
      <p><strong>가입일:</strong> {{ user.date_joined|date:"Y년 m월 d일" }}</p>
      <a href="{% url 'change_password' %}" class="btn btn-outline-dark btn-sm mt-3">비밀번호 재설정</a>
    </div>
  </div>

  <!-- 설정 -->
  <div class="card mb-4">
    <div class="card-header">설정</div>
    <div class="card-body">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="toggleNotification" {% if user.profile.allow_notification %}checked{% endif %}>
        <label class="form-check-label" for="toggleNotification">알림 수신</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleLocation" {% if user.profile.allow_location %}checked{% endif %}>
        <label class="form-check-label" for="toggleLocation">위치 정보 제공</label>
      </div>
    </div>
  </div>

  <!-- 잃어버린 물건 -->
  <div class="card mb-4">
    <div class="card-header">내가 잃어버린 물건</div>
    <div class="card-body">
      <div class="list-group">
        {% for item in lost_items %}
        <a href="{% url 'post_detail' item.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          {{ item.title }}
          <span class="badge bg-secondary">{{ item.status }}</span>
        </a>
        {% empty %}
        <p>잃어버린 물건이 없습니다.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 습득한 물건 -->
  <div class="card mb-4">
    <div class="card-header">내가 습득한 물건</div>
    <div class="card-body">
      <div class="list-group">
        {% for item in found_items %}
        <a href="{% url 'post_detail' item.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          {{ item.title }}
          <span class="badge bg-success">{{ item.status }}</span>
        </a>
        {% empty %}
        <p>습득한 물건이 없습니다.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 계정 관련 -->
  <div class="logout-box text-center">
    <a href="{% url 'logout' %}" class="btn btn-outline-secondary mb-2">로그아웃</a><br>
    <a href="{% url 'quit_account' %}" class="btn btn-outline-danger btn-sm">탈퇴하기</a>
  </div>
</div>

<script>
  document.getElementById("toggleNotification").addEventListener("change", async (e) => {
    if (e.target.checked) {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        alert("알림 권한이 거부되었습니다.");
        e.target.checked = false;
      }
    }
    fetch("{% url 'update_setting' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ setting: "notification", value: e.target.checked })
    });
  });

  document.getElementById("toggleLocation").addEventListener("change", (e) => {
    if (e.target.checked) {
      navigator.geolocation.getCurrentPosition(
        () => {
          fetch("{% url 'update_setting' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ setting: "location", value: true })
          });
        },
        () => {
          alert("위치 권한이 거부되었습니다.");
          e.target.checked = false;
        }
      );
    } else {
      fetch("{% url 'update_setting' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ setting: "location", value: false })
      });
    }
  });
</script>
{% endblock %}
