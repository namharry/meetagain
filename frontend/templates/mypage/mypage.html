{% extends 'base/base.html' %}

{% block title %}마이페이지 - MeetAgain{% endblock %}

{% block extra_head %}
<style>
  body { 
    font-family:'Noto Sans KR',sans-serif; 
    background-color: #f8f9fa; /* help_faq.html과 동일하게 변경 */
    color:#333; 
  }
  .mypage-container { 
    max-width:900px; 
    background:#fff; 
    padding:40px; 
    margin:60px auto; 
    border-radius:12px; 
    box-shadow:0 0 20px rgba(0,0,0,.05); 
  }
  .mypage-title { 
    font-weight:700; 
    font-size:1.8rem; 
    color:#5e3dc6; 
    text-align:center; 
    margin-bottom:30px; 
  }
  .card { 
    border:1px solid #e5defb;
    border-radius:16px;
    box-shadow:0 10px 24px rgba(93,63,199,.08);
  }
  .card-header {
    background:#e7e1ff; 
    color:#5e3dc6; 
    font-weight:700; 
    border:none;
    padding:10px 18px; 
    box-shadow: inset 0 -1px 0 rgba(93,63,199,.25); 
  }
  .list-group-item { 
    border:none; 
    background:#f9f8fc; 
    margin-bottom:10px; 
    border-radius:10px; 
    padding:14px 16px; 
  }
  .list-title { 
    font-weight:600; 
  }
  .badge-pill { 
    border-radius:999px; 
    padding:.35rem .7rem; 
    font-weight:600; 
  }
  .badge-lost { 
    background:#7B3FF2; 
  }
  .badge-found { 
    background:#23c483; 
  }
  .empty { 
    color:#888; 
    background:#f8f7fb; 
    border:1px dashed #e5defb; 
    padding:18px; 
    border-radius:10px; 
    text-align:center; 
  }
  .switch-wrap { 
    display:flex; 
    align-items:center; 
    gap:10px; 
  }
  .btn-primary { 
    background:#7B3FF2; 
    border:none;
  }
  .btn-primary:hover { 
    background:#6931d4; 
  }
  .btn-outline-secondary:hover { 
    background:#f0eef9; 
    color:#5e3dc6; 
    border-color:#d6ccff; 
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="max-width: 700px;">
  <h2 class="mb-4">마이페이지</h2>

  <!-- 내 정보 -->
  <div class="card mb-4">
    <div class="card-header">내 정보</div>
    <div class="card-body">
      <p><strong>학번:</strong> {{ user.student_id }}</p>
      <p><strong>이메일:</strong> {{ user.email }}</p>
      <p><strong>가입일:</strong> {{ user.date_joined|date:"Y년 m월 d일" }}</p>
    </div>
  </div>

  <!-- 설정 -->
  <div class="card mb-4">
    <div class="card-header">설정</div>
    <div class="card-body">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="toggleNotification" {% if user.allow_notification %}checked{% endif %}>
        <label class="form-check-label" for="toggleNotification">알림 수신</label>
      </div>
    </div>
  </div>

  <!-- 잃어버린 물건 -->
  <div class="card mb-4">
    <div class="card-header">내가 잃어버린 물건</div>
    <div class="card-body">
      <div class="list-group">
        {% for item in lost_items %}
        <a href="{% url 'meetagain:lost_detail' item.id %}"
           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          {{ item.title }}
          <span class="badge bg-secondary">{{ item.status }}</span>
        </a>
        {% empty %}
        <p>잃어버린 물건이 없습니다.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 습득한 물건 -->
  <div class="card mb-4">
    <div class="card-header">내가 습득한 물건</div>
    <div class="card-body">
      <div class="list-group">
        {% for item in found_items %}
        <a href="{% url 'meetagain:found_detail' item.id %}"
           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          {{ item.title }}
          <span class="badge bg-success">{{ item.status }}</span>
        </a>
        {% empty %}
        <p>습득한 물건이 없습니다.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 계정 관련 -->
  <div class="logout-box text-center">
    <a href="{% url 'users:logout' %}" class="btn btn-outline-secondary mb-2">로그아웃</a><br>
    <a href="{% url 'meetagain:quit_account' %}" class="btn btn-outline-danger btn-sm">탈퇴하기</a>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Django CSRF 토큰 쿠키에서 읽기 (폼 밖 fetch에서도 안전)
  function getCookie(name) {
    const value = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return value ? decodeURIComponent(value.split('=')[1]) : '';
  }
  const CSRF = getCookie('csrftoken');

  document.addEventListener('DOMContentLoaded', () => {
    const notifEl = document.getElementById("toggleNotification");
    
    if (notifEl) {
      notifEl.addEventListener("change", async (e) => {
        if (e.target.checked) {
          const permission = await Notification.requestPermission();
          if (permission !== "granted") {
            alert("알림 권한이 거부되었습니다.");
            e.target.checked = false;
          }
        }
        fetch("{% url 'users:update_setting' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF
          },
          body: JSON.stringify({ setting: "notification", value: e.target.checked })
        });
      });
    }

  });
</script>
{% endblock %}
