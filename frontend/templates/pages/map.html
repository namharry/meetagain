{% extends 'base/base.html' %}
{% load static %}

{% block title %}ë¶„ì‹¤ë¬¼ ë“±ë¡ (ì§€ë„ í¬í•¨) - MeetAgain{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">ğŸ—ºï¸ ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</h2>

  <!-- ì§€ë„ -->
  <div id="map" style="width: 100%; height: 350px; margin-bottom: 20px; background: #eee;"></div>

  <!-- í¼ -->
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="mb-3">
      <label for="id_location" class="form-label">ì¥ì†Œ</label>
      {{ form.location|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="id_image" class="form-label">ì‚¬ì§„</label>
      {{ form.image|add_class:"form-control" }}
    </div>

    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('map');
    const map = new kakao.maps.Map(container, {
      center: new kakao.maps.LatLng(37.5922, 127.0165),
      level: 3
    });

    const geocoder = new kakao.maps.services.Geocoder();

    // í•˜ë‚˜ë§Œ ê³µìœ í•´ì„œ ì“°ëŠ” ë§ˆì»¤/ì¸í¬ìœˆë„ìš°
    const marker = new kakao.maps.Marker({ map: null });
    const infowindow = new kakao.maps.InfoWindow({ removable: true });
    let lastContent = '';

    const locInput = document.getElementById('id_location');

    // ì§€ë„ í´ë¦­: ì¢Œí‘œ -> ì£¼ì†Œ ë³€í™˜, ë§ˆì»¤ ì´ë™ + ì¸í’‹ ì±„ìš°ê¸° + ì¸í¬ìœˆë„ìš° ì—´ê¸°
    kakao.maps.event.addListener(map, 'click', function (e) {
      const latlng = e.latLng;
      geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function (result, status) {
        if (status !== kakao.maps.services.Status.OK) return;

        const address = result[0].address.address_name;

        if (locInput) locInput.value = address;

        marker.setPosition(latlng);
        marker.setMap(map);

        const content = `<div style="padding:8px 10px;">${address}</div>`;
        lastContent = content;
        infowindow.setContent(content);
        infowindow.open(map, marker);
      });
    });

    // ë§ˆì»¤ í´ë¦­: ê°™ì€ ë‚´ìš©ì´ë©´ í† ê¸€(ë‹«ê¸°), ì•„ë‹ˆë©´ ì—´ê¸°
    kakao.maps.event.addListener(marker, 'click', function () {
      // ì¸í¬ìœˆë„ìš°ê°€ ì—´ë ¤ ìˆê³ , ë§ˆì§€ë§‰ ì»¨í…ì¸ ì™€ ë™ì¼í•˜ë©´ -> ë‹«ê¸°(í† ê¸€)
      if (infowindow.getMap()) {
        infowindow.close();
      } else {
        infowindow.setContent(lastContent || '<div style="padding:8px 10px;">ì„ íƒëœ ìœ„ì¹˜</div>');
        infowindow.open(map, marker);
      }
    });

    // ì§€ë„ ë¹ˆ ê³³ í´ë¦­: ì¸í¬ìœˆë„ìš° ë‹«ê¸°
    kakao.maps.event.addListener(map, 'rightclick', function () {
      // ìš°í´ë¦­ ì§€ë„: ì¸í¬ë§Œ ë‹«ê¸°(ì´ˆê¸°í™”ëŠ” ë§ˆì»¤ ìš°í´ë¦­ì—ì„œ)
      infowindow.close();
    });

    // ë§ˆì»¤ ìš°í´ë¦­: ì‚­ì œ
    kakao.maps.event.addListener(marker, 'rightclick', function () {
      infowindow.close();
      marker.setMap(null);
      lastContent = '';
      if (locInput) locInput.value = '';
    });

    // ESC í‚¤ë¡œë„ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
    document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') infowindow.close();
    });
  });
</script>
{% endblock %}
