{% extends 'base/base.html' %}
{% block title %}MeetAgain - 습득물 조회{% endblock %}

{% block extra_head %}
<style>
  .lost-card .thumb {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    border-top-left-radius: .5rem;
    border-top-right-radius: .5rem;
    background: #f6f6f6;
  }
  .lost-card .card-body {
    min-height: 96px;
  }

  /* 보라색 페이지네이션 */
  .purple-pagination{
    display:inline-flex; align-items:center; gap:2px;
    background:#f5efff; border-radius:12px; padding:4px;
    border:1px solid #e4d9ff;
  }
  .purple-pagination .pg-btn{
    min-width:36px; height:36px; line-height:36px; text-align:center;
    border-radius:8px; cursor:pointer; user-select:none;
    padding:0 10px; font-weight:600; color:#4c3c88; background:transparent; border:none;
  }
  .purple-pagination .pg-btn:hover{ background:#efe7ff; }
  .purple-pagination .active{ background:#7B3FF2; color:#fff; }
  .purple-pagination .disabled{ opacity:.4; pointer-events:none; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 position-relative">
  <h4 class="text-center mb-4 fw-bold" style="font-size: 24px;">MeetAgain</h4>

  <div class="row">
    <!-- 좌측: 검색 + 목록 -->
    <div class="col-md-7">
      <form id="searchForm" method="get" action="{% url 'meetagain:index' %}">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">종류</label>
            <select name="category" id="typeSelect" class="form-select">
              <option value="">종류 선택</option>
              {% for cat, cat_label in items.model.CATEGORY_CHOICES %}
                <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">습득물명</label>
            <input type="text" name="name" value="{{ request.GET.name }}" class="form-control" placeholder="예: 파란색 우산">
          </div>
          <div class="col-md-12">
            <label class="form-label">습득 기간</label>
            <div class="d-flex gap-2">
              <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
              <span class="align-self-center">~</span>
              <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
            </div>
          </div>
          <div class="col-md-12">
            <label class="form-label">습득 장소</label>
            <input type="text" name="location" value="{{ request.GET.location }}" class="form-control" placeholder="예: 중앙도서관">
          </div>
          <div class="col-12 text-end mt-3">
            <button type="submit" class="btn btn-primary">검색</button>
          </div>
        </div>
      </form>

      <!-- 리스트 (AJAX로 채움) -->
      <h5 class="mb-3 mt-4">📋 등록된 습득물 리스트</h5>
      <div class="row row-cols-1 row-cols-md-3 g-4 mb-3" id="items"></div>

      <!-- 숫자 페이지네이션 (보라) -->
      <div class="d-flex justify-content-center mb-4">
        <div id="pager" class="purple-pagination"></div>
      </div>
    </div>

    <!-- 우측: 지도 -->
    <div class="col-md-5">
      <div id="map" style="width:100%; height:380px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,.06);"></div>
      <div class="d-flex gap-2 mt-3">
        <a href="{% url 'meetagain:found_register' %}" class="btn btn-found px-5 py-5 w-50 flex-fill">
          📥 물건을 주웠어요!<br><small>(습득물 등록)</small>
        </a>
        <a href="{% url 'meetagain:lost_register' %}" class="btn btn-lost px-5 py-5 w-50 flex-fill">
          📤 물건을 잃어버렸어요..<br><small>(분실물 신고)</small>
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* 전역 유틸: XSS 방지 */
  function escapeHtml(s){
    if (s == null) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  // ===== 지도: 현재 URL 쿼리 그대로 반영 =====
  window.addEventListener('load', function () {
    initMap();
    // 페이지 로드 시 1페이지 가져오기
    fetchPage(1);

    // 검색폼 submit 시에도 1페이지부터 다시 (원하면 Ajax로 바꿀 수 있음)
    document.getElementById('searchForm').addEventListener('submit', function(e){
      // e.preventDefault(); fetchPage(1);
    });
  });

  function initMap(){
    const container = document.getElementById('map');
    if (!container || !window.kakao || !kakao.maps) return;

    const DEFAULT_CENTER = new kakao.maps.LatLng(37.591360, 127.021961);
    const map = new kakao.maps.Map(container, {
      center: DEFAULT_CENTER,
      level: 2,
      maxLevel: 4
    });

    const queryString = window.location.search;
    fetch(`/meetagain/api/items${queryString}`)
      .then(res => res.json())
      .then(({ items }) => {
        if (!items || items.length === 0) return;
        const bounds = new kakao.maps.LatLngBounds();
        const openInfoWindows = [];
        items.forEach(item => {
          if (item.lat == null || item.lng == null) return;
          const pos = new kakao.maps.LatLng(item.lat, item.lng);
          bounds.extend(pos);
          const marker = new kakao.maps.Marker({ position: pos, map: map });

          const detailUrl = `{% url 'meetagain:found_detail' item_id=0 %}`.replace('/0/', `/${item.id}/`);
          const content = `
            <div style="padding:8px 10px; min-width:180px; font-size:13px;">
              <div style="font-weight:700; margin-bottom:4px;">${escapeHtml(item.name)}</div>
              <div style="color:#666; margin-bottom:6px;">${item.date || ''}</div>
              <a href="${detailUrl}" style="text-decoration:none;">자세히 보기 →</a>
            </div>`;
          const iw = new kakao.maps.InfoWindow({ content });
          kakao.maps.event.addListener(marker, 'click', () => {
            openInfoWindows.forEach(w => w.close());
            iw.open(map, marker);
            openInfoWindows.push(iw);
          });
        });
        if (!bounds.isEmpty()) map.setBounds(bounds);
      })
      .catch(err => console.error('핀 데이터를 불러오지 못했습니다:', err));
  }

  // ===== AJAX 페이지네이션 =====
  const GRID  = document.getElementById('items');
  const PAGER = document.getElementById('pager');

  function buildQuery(extra={}) {
    const params = new URLSearchParams(window.location.search);
    for (const [k,v] of Object.entries(extra)) params.set(k, v);
    return params.toString() ? `?${params.toString()}` : '';
  }

  function fetchPage(page){
    fetch(`/meetagain/found/list_api/${buildQuery({page})}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        renderGrid(data.items);
        renderPager(data.page, data.total_pages);
      })
      .catch(err => {
        console.error('리스트 불러오기 실패:', err);
        GRID.innerHTML = `<p class="text-danger">목록을 불러오지 못했습니다. 새로고침 해보세요.</p>`;
      });
  }

  function renderGrid(items){
    const detailUrlTemplate = "{% url 'meetagain:found_detail' item_id=0 %}";

    GRID.innerHTML = items.map(it => {
      const detailUrl = detailUrlTemplate.replace('/0/', `/${it.id}/`);
      return `
        <div class="col">
          <a class="text-decoration-none" href="${detailUrl}">
            <div class="card lost-card h-100">
              ${it.image_url
                ? `<img src="${it.image_url}" alt="${escapeHtml(it.name)}" class="thumb">`
                : `<img src="https://via.placeholder.com/600x400?text=%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%86%EC%9D%8C" class="thumb" alt="이미지 없음">`}
              <div class="card-body">
                <p class="text-center fw-bold text-dark mb-1">${escapeHtml(it.name)}</p>
                <p class="text-center text-muted small mb-1">${it.found_date || ''}</p>
                <p class="text-center text-muted small">${escapeHtml(it.found_location || '')}</p>
              </div>
            </div>
          </a>
        </div>
      `;
    }).join('') || `<p class="text-muted">등록된 습득물이 없습니다.</p>`;
  }

  function renderPager(current, total){
    if (total <= 1){ PAGER.innerHTML = ''; return; }
    let html = '';
    const prevClass = (current > 1) ? 'pg-btn' : 'pg-btn disabled';
    const nextClass = (current < total) ? 'pg-btn' : 'pg-btn disabled';
    html += `<button class="${prevClass}" data-pg="${current-1}">&laquo;</button>`;
    for (let p = 1; p <= total; p++){
      html += `<button class="pg-btn ${p===current?'active':''}" data-pg="${p}">${p}</button>`;
    }
    html += `<button class="${nextClass}" data-pg="${current+1}">&raquo;</button>`;
    PAGER.innerHTML = html;
    PAGER.querySelectorAll('.pg-btn:not(.disabled)').forEach(btn=>{
      btn.onclick = () => fetchPage(parseInt(btn.dataset.pg, 10));
    });
  }
</script>
{% endblock %}
