{% extends 'base/base.html' %}
{% block title %}MeetAgain - ìŠµë“ë¬¼ ì¡°íšŒ{% endblock %}

{% block extra_head %}
<style>
  .lost-card .thumb {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    border-top-left-radius: .5rem;
    border-top-right-radius: .5rem;
    background: #f6f6f6;
  }
  .lost-card .card-body { min-height: 96px; }

  /* ë³´ë¼ìƒ‰ í˜ì´ì§€ë„¤ì´ì…˜ */
  .purple-pagination{
    display:inline-flex; align-items:center; gap:2px;
    background:#f5efff; border-radius:12px; padding:4px;
    border:1px solid #e4d9ff;
  }
  .purple-pagination .pg-btn{
    min-width:36px; height:36px; line-height:36px; text-align:center;
    border-radius:8px; cursor:pointer; user-select:none;
    padding:0 10px; font-weight:600; color:#4c3c88; background:transparent; border:none;
  }
  .purple-pagination .pg-btn:hover{ background:#efe7ff; }
  .purple-pagination .active{ background:#7B3FF2; color:#fff; }
  .purple-pagination .disabled{ opacity:.4; pointer-events:none; }

  /* ğŸ”§ ì„¸ë¶€ì˜µì…˜ ì—†ìŒì¼ ë•Œ: íšŒìƒ‰ ë°°ê²½ ì œê±°í•˜ê³  í´ë¦­ë§Œ ë§‰ê¸° */
  #subSelect.no-sub {
    pointer-events: none;    /* ì—´ë¦¬ì§€ ì•ŠìŒ */
    background-color: #fff;  /* íšŒìƒ‰ ì•„ë‹˜ */
    opacity: 1;              /* Bootstrap ê¸°ë³¸ íë¦¼ ì œê±° */
    color: #6c757d;          /* ì‚´ì§ë§Œ íë¦¬ê²Œ */
  }

  /* âœ… ì§€ë„ í•€ ìœ„ í…ìŠ¤íŠ¸ ë¼ë²¨ */
  .ma-label{
    position: relative;
    transform: translate(-50%, -110%); /* ë§ˆì»¤ ìœ„ë¡œ ì‚´ì§ */
    padding: 4px 8px;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 8px;
    background: rgba(255,255,255,.95);
    box-shadow: 0 2px 6px rgba(0,0,0,.12);
    font-size: 12px;
    line-height: 1.2;
    white-space: nowrap;
    pointer-events: none; /* ë¼ë²¨ì´ í´ë¦­ ë§‰ì§€ ì•Šê²Œ */
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 position-relative">
  <h4 class="text-center mb-4 fw-bold" style="font-size: 24px;">MeetAgain</h4>

  <div class="row">
    <!-- ì¢Œì¸¡: ê²€ìƒ‰ + ëª©ë¡ -->
    <div class="col-md-7">
      <form id="searchForm" method="get" action="{% url 'meetagain:index' %}">
        <div class="row g-2">
          <!-- 1ì¤„: ì¢…ë¥˜ + ì„¸ë¶€ì˜µì…˜ -->
          <div class="col-md-6">
            <label class="form-label">ì¢…ë¥˜</label>
            <select name="category" id="typeSelect" class="form-select">
              <option value="">ì¢…ë¥˜ ì„ íƒ</option>
              {% for cat, cat_label in items.model.CATEGORY_CHOICES %}
                <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">ì„¸ë¶€ì˜µì…˜</label>
            <!-- ê°’ ìœ ì§€ìš© data-attr -->
            <select name="subcategory" id="subSelect" class="form-select"
                    data-subselected="{{ request.GET.subcategory|default:'' }}">
              <option value="">ì„¸ë¶€ì˜µì…˜ ì„ íƒ</option>
            </select>
          </div>

          <!-- 2ì¤„: ê¸°ê°„ -->
          <div class="col-md-12">
            <label class="form-label">ìŠµë“ ê¸°ê°„</label>
            <div class="d-flex gap-2">
              <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
              <span class="align-self-center">~</span>
              <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
            </div>
          </div>

          <!-- 3ì¤„: ì¥ì†Œ -->
          <div class="col-md-12">
            <label class="form-label">ìŠµë“ ì¥ì†Œ</label>
            <select name="location" class="form-select">
              <option value="">ì¥ì†Œ ì„ íƒ</option>
              {% for value, label in location_choices %}
                <option value="{{ value }}" {% if request.GET.location == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- 4ì¤„: ë¬¼í’ˆëª… -->
          <div class="col-md-12">
            <label class="form-label">ìŠµë“ë¬¼ëª…</label>
            <input type="text" name="name" value="{{ request.GET.name }}" class="form-control" placeholder="ì˜ˆ: íŒŒë€ìƒ‰ ìš°ì‚°">
          </div>

          <!-- ë²„íŠ¼ -->
          <div class="col-12 text-end mt-3">
            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
          </div>
        </div>
      </form>

      <h5 class="mb-3 mt-4">ğŸ“‹ ë“±ë¡ëœ ìŠµë“ë¬¼ ë¦¬ìŠ¤íŠ¸</h5>
      <div class="row row-cols-1 row-cols-md-3 g-4 mb-3" id="items"></div>

      <div class="d-flex justify-content-center mb-4">
        <div id="pager" class="purple-pagination"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ì§€ë„ -->
    <div class="col-md-5">
      <div id="map" style="width:100%; height:380px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,.06);"></div>
      <div class="d-flex gap-2 mt-3">
        <a href="{% url 'meetagain:found_register' %}" class="btn btn-found px-5 py-5 w-50 flex-fill">
          ğŸ“¥ ë¬¼ê±´ì„ ì£¼ì› ì–´ìš”!<br><small>(ìŠµë“ë¬¼ ë“±ë¡)</small>
        </a>
        <a href="{% url 'meetagain:lost_register' %}" class="btn btn-lost px-5 py-5 w-50 flex-fill">
          ğŸ“¤ ë¬¼ê±´ì„ ìƒì–´ë²„ë ¸ì–´ìš”..<br><small>(ë¶„ì‹¤ë¬¼ ì‹ ê³ )</small>
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ì „ì—­ ìœ í‹¸: XSS ë°©ì§€ */
  function escapeHtml(s){
    if (s == null) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  // ===== ì„¸ë¶€ì˜µì…˜ ë§¤í•‘ (ë¼ë²¨ ê¸°ì¤€) =====
  const SUB_OPTIONS = {
    'ì¹´ë“œ': [],
    'ì§€ê°‘': [],
    'ì „ìê¸°ê¸°': ['íƒœë¸”ë¦¿','ìŠ¤ë§ˆíŠ¸ì›Œì¹˜','ë¬´ì„ ì´ì–´í°','ì¹´ë©”ë¼','í—¤ë“œì…‹','ê¸°íƒ€ìš©í’ˆ'],
    'ì˜ë¥˜': ['ëª¨ì','ì‹ ë°œ','ì•„ìš°í„°','ê¸°íƒ€ì˜ë¥˜'],
    'ê°€ë°©': [],
    'ì‹ ë°œ': [],
    'ë¬¸ì„œ/ì„œë¥˜': [],
    'ê·€ê¸ˆì†': ['ë°˜ì§€','ëª©ê±¸ì´','ê·€ê±¸ì´','ì‹œê³„','ê¸°íƒ€'],
    'ì•…ê¸°': [],
    'ì±…/ë…¸íŠ¸': [],
    'ìŠ¤í¬ì¸  ìš©í’ˆ': [],
    'ì‹ ë¶„ì¦': [],
    'í˜„ê¸ˆ': [],
    'ê¸°íƒ€': []
  };

  function fillSubOptions(categoryLabel, selectedValue){
    const sub = document.getElementById('subSelect');
    const list = SUB_OPTIONS[categoryLabel] || [];

    sub.innerHTML = '';
    if (list.length === 0){
      // ğŸ”¸ ì„¸ë¶€ì˜µì…˜ ì—†ìŒ: ì¼ë°˜ ìŠ¤íƒ€ì¼ ìœ ì§€ + í´ë¦­ë§Œ ë§‰ìŒ
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ì„¸ë¶€ì˜µì…˜ ì—†ìŒ';
      sub.appendChild(opt);
      sub.classList.add('no-sub');   // ìŠ¤íƒ€ì¼ë¡œ pointer-eventsë§Œ ë§‰ìŒ
      sub.value = '';
      return;
    }

    // ì„ íƒ ê°€ëŠ¥
    sub.classList.remove('no-sub');
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'ì„¸ë¶€ì˜µì…˜ ì„ íƒ';
    sub.appendChild(ph);
    list.forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sub.appendChild(o);
    });
    sub.value = (selectedValue && list.includes(selectedValue)) ? selectedValue : '';
  }

  function currentCategoryLabel(){
    const sel = document.getElementById('typeSelect');
    if (!sel) return '';
    return sel.options[sel.selectedIndex]?.text?.trim() || '';
  }

  // ===== ë¼ë²¨/ì´ë¦„ í‘œì‹œ ì„¤ì • =====
  const MAX_NAME_LEN = 8;      // ì´ë¦„ 8ì ì´ˆê³¼ì‹œ â€¦ ì²˜ë¦¬
  const LABEL_SHOW_LEVEL = 3;  // ì´ ë ˆë²¨ "ì´í•˜"ì—ì„œë§Œ ë¼ë²¨ í‘œì‹œ(ê°€ê¹Œì´ì„œë§Œ)

  function truncateName(name, limit = MAX_NAME_LEN){
    if (!name) return '';
    return name.length > limit ? name.slice(0, limit) + 'â€¦' : name;
  }

  // ===== ì§€ë„ & ì´ˆê¸°í™” =====
  window.addEventListener('load', function () {
    // ì„¸ë¶€ì˜µì…˜ ì´ˆê¸° ì„¸íŒ…
    const subSelected = document.getElementById('subSelect').dataset.subselected || '';
    fillSubOptions(currentCategoryLabel(), subSelected);

    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì„¸ë¶€ì˜µì…˜ ê°±ì‹ 
    document.getElementById('typeSelect').addEventListener('change', function(){
      fillSubOptions(currentCategoryLabel(), '');
    });

    initMap();
    fetchPage(1);
  });

  function initMap(){
    const container = document.getElementById('map');
    if (!container || !window.kakao || !kakao.maps) return;

    const DEFAULT_CENTER = new kakao.maps.LatLng(37.591360, 127.021961);
    const map = new kakao.maps.Map(container, {
      center: DEFAULT_CENTER,
      level: 2,
      maxLevel: 5
    });

    // âœ… í•˜ë‚˜ë§Œ ë§Œë“¤ì–´ì„œ ì¬ì‚¬ìš©
    const infoWindow = new kakao.maps.InfoWindow({ zIndex: 3, removable: true });

    // âœ… ESCë¡œ ë‹«ê¸°
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape' && infoWindow.getMap()) infoWindow.close();
    });

    // âœ… ì§€ë„ ì™¼ìª½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°(ë¹ˆê³µê°„ í´ë¦­)
    kakao.maps.event.addListener(map, 'click', () => {
      if (infoWindow.getMap()) infoWindow.close();
    });

    // ë§ˆì»¤/ë¼ë²¨ ì €ì¥
    const markers = [];
    const labels  = [];

    const queryString = window.location.search;
    fetch(`/meetagain/api/items${queryString}`)
      .then(res => res.json())
      .then(({ items }) => {
        if (!items || items.length === 0) return;
        const bounds = new kakao.maps.LatLngBounds();

        // ìƒì„¸ URL í…œí”Œë¦¿(ì¥ê³  reverseë¥¼ ì´ìš©í•´ idë§Œ ì¹˜í™˜)
        const detailUrlTemplate = `{% url 'meetagain:found_detail' item_id=0 %}`;

        items.forEach(item => {
          if (item.lat == null || item.lng == null) return;

          const pos = new kakao.maps.LatLng(item.lat, item.lng);
          bounds.extend(pos);

          // 1) ë§ˆì»¤
          const marker = new kakao.maps.Marker({ position: pos, map });
          markers.push(marker);

          // 2) ë¼ë²¨(CustomOverlay)
          const labelEl = document.createElement('div');
          labelEl.className = 'ma-label';
          labelEl.textContent = truncateName(item.name);

          const label = new kakao.maps.CustomOverlay({
            position: pos,
            content: labelEl,
            yAnchor: 1.1,  // ë§ˆì»¤ ìœ„ë¡œ ì•½ê°„ ë„ìš°ê¸°
            zIndex: 2
          });
          labels.push(label);

          // 3) íŒì—…(ì¸ë„¤ì¼ + í…ìŠ¤íŠ¸ + ë§í¬)
          const detailUrl = detailUrlTemplate.replace('/0/', `/${item.id}/`);
          const thumb = item.thumbnail_url ? `
            <img src="${item.thumbnail_url}" alt="${escapeHtml(item.name)}"
                 style="width:80px;height:80px;object-fit:cover;border-radius:6px;margin-right:8px;">
          ` : '';

          const content = `
            <div style="display:flex;align-items:center;gap:8px;max-width:260px;padding:8px 10px;">
              ${thumb}
              <div style="min-width:0;">
                <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(item.name)}</div>
                <div style="color:#666;margin-bottom:6px;font-size:12px;">${item.date || ''}</div>
                <a href="${detailUrl}" style="font-size:12px;text-decoration:underline;">ìì„¸íˆ ë³´ê¸° â†’</a>
              </div>
            </div>`;

          kakao.maps.event.addListener(marker, 'click', () => {
            if (infoWindow.getMap()) infoWindow.close();
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
          });
        });

        if (!bounds.isEmpty()) map.setBounds(bounds);

        // ì´ˆê¸° ë¼ë²¨ í‘œì‹œ/ìˆ¨ê¹€
        toggleLabelsByZoom();

        // ì¤Œ ë³€ê²½ ì‹œ ë¼ë²¨ í‘œì‹œ/ìˆ¨ê¹€
        kakao.maps.event.addListener(map, 'zoom_changed', toggleLabelsByZoom);

        function toggleLabelsByZoom(){
          const lv = map.getLevel();
          if (lv <= LABEL_SHOW_LEVEL){
            labels.forEach(l => { if (!l.getMap()) l.setMap(map); });
          } else {
            labels.forEach(l => { if (l.getMap()) l.setMap(null); });
          }
        }
      })
      .catch(err => console.error('í•€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', err));
  }

  // ===== AJAX í˜ì´ì§€ë„¤ì´ì…˜ =====
  const GRID  = document.getElementById('items');
  const PAGER = document.getElementById('pager');

  function buildQuery(extra={}) {
    const params = new URLSearchParams(window.location.search);
    for (const [k,v] of Object.entries(extra)) params.set(k, v);
    return params.toString() ? `?${params.toString()}` : '';
  }

  function fetchPage(page){
    fetch(`/meetagain/found/list_api/${buildQuery({page})}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        renderGrid(data.items);
        renderPager(data.page, data.total_pages);
      })
      .catch(err => {
        console.error('ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        GRID.innerHTML = `<p class="text-danger">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.</p>`;
      });
  }

  function renderGrid(items){
    const detailUrlTemplate = "{% url 'meetagain:found_detail' item_id=0 %}";
    GRID.innerHTML = items.map(it => {
      const detailUrl = detailUrlTemplate.replace('/0/', `/${it.id}/`);
      return `
        <div class="col">
          <a class="text-decoration-none" href="${detailUrl}">
            <div class="card lost-card h-100">
              ${it.image_url
                ? `<img src="${it.image_url}" alt="${escapeHtml(it.name)}" class="thumb">`
                : `<img src="https://via.placeholder.com/600x400?text=%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%86%EC%9D%8C" class="thumb" alt="ì´ë¯¸ì§€ ì—†ìŒ">`}
              <div class="card-body">
                <p class="text-center fw-bold text-dark mb-1">${escapeHtml(it.name)}</p>
                <p class="text-center text-muted small mb-1">${it.found_date || ''}</p>
                <p class="text-center text-muted small">${escapeHtml(it.found_location || '')}</p>
              </div>
            </div>
          </a>
        </div>
      `;
    }).join('') || `<p class="text-muted">ë“±ë¡ëœ ìŠµë“ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }

  function renderPager(current, total){
    if (total <= 1){ PAGER.innerHTML = ''; return; }
    let html = '';
    const prevClass = (current > 1) ? 'pg-btn' : 'pg-btn disabled';
    const nextClass = (current < total) ? 'pg-btn' : 'pg-btn disabled';
    html += `<button class="${prevClass}" data-pg="${current-1}">&laquo;</button>`;
    for (let p = 1; p <= total; p++){
      html += `<button class="pg-btn ${p===current?'active':''}" data-pg="${p}">${p}</button>`;
    }
    html += `<button class="${nextClass}" data-pg="${current+1}">&raquo;</button>`;
    PAGER.innerHTML = html;
    PAGER.querySelectorAll('.pg-btn:not(.disabled)').forEach(btn=>{
      btn.onclick = () => fetchPage(parseInt(btn.dataset.pg, 10));
    });
  }
</script>
{% endblock %}
