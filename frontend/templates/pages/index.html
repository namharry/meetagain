{% extends 'base/base.html' %}
{% block title %}MeetAgain - ìŠµë“ë¬¼ ì¡°íšŒ{% endblock %}

{% block extra_head %}
<style>
  .lost-card .thumb {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    border-top-left-radius: .5rem;
    border-top-right-radius: .5rem;
    background: #f6f6f6;
  }
  .lost-card .card-body {
    min-height: 96px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 position-relative">
  <h4 class="text-center mb-4 fw-bold" style="font-size: 24px;">MeetAgain</h4>

  <div class="row">
    <!-- ì¢Œì¸¡: ê²€ìƒ‰ + ëª©ë¡ -->
    <div class="col-md-7">
      <form method="get" action="{% url 'meetagain:index' %}">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">ì¢…ë¥˜</label>
            <select name="category" id="typeSelect" class="form-select" onchange="updateSubOptions()">
              <option value="">ì¢…ë¥˜ ì„ íƒ</option>
              {% for cat, cat_label in items.model.CATEGORY_CHOICES %}
                <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">ìŠµë“ë¬¼ëª…</label>
            <input type="text" name="name" value="{{ request.GET.name }}" class="form-control" placeholder="ì˜ˆ: íŒŒë€ìƒ‰ ìš°ì‚°">
          </div>
          <div class="col-md-12">
            <label class="form-label">ìŠµë“ ê¸°ê°„</label>
            <div class="d-flex gap-2">
              <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
              <span class="align-self-center">~</span>
              <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
            </div>
          </div>
          <div class="col-md-12">
            <label class="form-label">ìŠµë“ ì¥ì†Œ</label>
            <input type="text" name="location" value="{{ request.GET.location }}" class="form-control" placeholder="ì˜ˆ: ì¤‘ì•™ë„ì„œê´€">
          </div>
          <div class="col-12 text-end mt-3">
            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
          </div>
        </div>
      </form>

      <!-- ë¦¬ìŠ¤íŠ¸ -->
      <h5 class="mb-3 mt-4">ğŸ“‹ ë“±ë¡ëœ ìŠµë“ë¬¼ ë¦¬ìŠ¤íŠ¸</h5>
      <div class="row row-cols-1 row-cols-md-3 g-4 mb-4" id="items">
        {% for item in items %}
        <div class="col">
          <a class="text-decoration-none" href="{% url 'meetagain:found_detail' item_id=item.id %}">
            <div class="card lost-card h-100">
              {% if item.image %}
                <img src="{{ item.image.url }}" alt="{{ item.name }}" class="thumb">
              {% else %}
                <img src="https://via.placeholder.com/600x400?text=%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%86%EC%9D%8C" alt="ì´ë¯¸ì§€ ì—†ìŒ" class="thumb">
              {% endif %}
              <div class="card-body">
                <p class="text-center fw-bold text-dark mb-1">{{ item.name }}</p>
                <p class="text-center text-muted small mb-1">{{ item.found_date|date:"Y-m-d" }}</p>
                <p class="text-center text-muted small">{{ item.found_location }}</p>
              </div>
            </div>
          </a>
        </div>
        {% empty %}
          <p class="text-muted">ë“±ë¡ëœ ìŠµë“ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
      </div>
    </div>

    <!-- ìš°ì¸¡: ì§€ë„ -->
    <div class="col-md-5">
      <div id="map" style="width:100%; height:380px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,.06);"></div>
      <div class="d-flex gap-2 mt-3">
        <a href="{% url 'meetagain:found_register' %}" class="btn btn-found px-5 py-5 w-50 flex-fill">
          ğŸ“¥ ë¬¼ê±´ì„ ì£¼ì› ì–´ìš”!<br><small>(ìŠµë“ë¬¼ ë“±ë¡)</small>
        </a>
        <a href="{% url 'meetagain:lost_register' %}" class="btn btn-lost px-5 py-5 w-50 flex-fill">
          ğŸ“¤ ë¬¼ê±´ì„ ìƒì–´ë²„ë ¸ì–´ìš”..<br><small>(ë¶„ì‹¤ë¬¼ ì‹ ê³ )</small>
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ì„¸ë¶€ì˜µì…˜ í”„ë¦¬ì…‹
  const subOptions = {
    "ê·€ê¸ˆì†": ["ë°˜ì§€", "ëª©ê±¸ì´", "ê·€ê±¸ì´", "ì‹œê³„", "ê¸°íƒ€"],
    "ì˜ë¥˜": ["ëª¨ì", "ì‹ ë°œ", "ì•„ìš°í„°", "ê¸°íƒ€ì˜ë¥˜"],
    "ì „ìê¸°ê¸°": ["íƒœë¸”ë¦¿", "ìŠ¤ë§ˆíŠ¸ì›Œì¹˜", "ë¬´ì„ ì´ì–´í°", "ì¹´ë©”ë¼", "í—¤ë“œì…‹", "ê¸°íƒ€ìš©í’ˆ"]
  };
  function updateSubOptions() {
    const type = document.getElementById("typeSelect").value;
    const subSelect = document.getElementById("subOptionSelect");
    subSelect.innerHTML = '<option disabled selected>ì„¸ë¶€ì˜µì…˜ ì„ íƒ</option>';
    if (subOptions[type]) {
      subOptions[type].forEach(opt => {
        const o = document.createElement("option");
        o.value = o.text = opt;
        subSelect.appendChild(o);
      });
    } else {
      const o = document.createElement("option");
      o.text = "í•´ë‹¹ ì—†ìŒ";
      subSelect.appendChild(o);
    }
  }
</script>

<script>
  window.addEventListener('load', function () {
    const container = document.getElementById('map');
    if (!container || !window.kakao || !kakao.maps) return;

    const DEFAULT_CENTER = new kakao.maps.LatLng(37.591360, 127.021961);
    const map = new kakao.maps.Map(container, {
      center: DEFAULT_CENTER,
      level: 2,
      maxLevel: 4
    });

    // í˜„ì¬ í˜ì´ì§€ì˜ GET íŒŒë¼ë¯¸í„°ë¥¼ ê·¸ëŒ€ë¡œ APIì— ì „ë‹¬
    const queryString = window.location.search; 
    fetch(`/meetagain/api/items${queryString}`)
      .then(res => res.json())
      .then(({ items }) => {
        if (!items || items.length === 0) return;

        const bounds = new kakao.maps.LatLngBounds();
        const openInfoWindows = [];

        items.forEach(item => {
          if (item.lat == null || item.lng == null) return;

          const pos = new kakao.maps.LatLng(item.lat, item.lng);
          bounds.extend(pos);

          const marker = new kakao.maps.Marker({ position: pos, map: map });
          const detailUrl = `{% url 'meetagain:found_detail' item_id=0 %}`.replace('/0/', `/${item.id}/`);

          const content = `
            <div style="padding:8px 10px; min-width:180px; font-size:13px;">
              <div style="font-weight:700; margin-bottom:4px;">${escapeHtml(item.name)}</div>
              <div style="color:#666; margin-bottom:6px;">${item.date || ''}</div>
              <a href="${detailUrl}" style="text-decoration:none;">ìì„¸íˆ ë³´ê¸° â†’</a>
            </div>
          `;

          const iw = new kakao.maps.InfoWindow({ content });
          kakao.maps.event.addListener(marker, 'click', () => {
            openInfoWindows.forEach(w => w.close());
            iw.open(map, marker);
            openInfoWindows.push(iw);
          });
        });

        if (!bounds.isEmpty()) map.setBounds(bounds);
      })
      .catch(err => {
        console.error('í•€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', err);
      });

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  });
</script>
{% endblock %}
