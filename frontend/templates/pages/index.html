{% extends 'base/base.html' %} 
{% block title %}MeetAgain - ìŠµë“ë¬¼ ì¡°íšŒ{% endblock %}

{% block extra_head %}
<style>
  /* === ì„¹ì…˜ í—¤ë”(ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ ê³µí†µ) === */
  .section-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 1.1rem;
  }
  .section-chip{
    font-size: 1.25rem;
    font-weight: 700;
    padding: .6rem 1rem;
    background: #f3f4f6;
    border: 1px solid #e0e0e0;
    border-radius: 9999px;
    white-space: nowrap;
  }

  /* === ë ˆì´ì•„ì›ƒ (ì—¬ë°±ì€ ì ë‹¹íˆ, ì™¼ìª½ íŒ¨ë„ë§Œ ë„“í˜) === */
  @media (min-width: 1200px){
    .page-container{ max-width: 1420px; }
    .layout-row{ display:flex; gap: 24px; align-items: flex-start; }
    .left-narrow{ flex: 1 1 auto; max-width: 980px; }
    .right-map{  flex: 0 0 540px; max-width: 540px; }
  }
  @media (min-width: 1400px){
    .page-container{ max-width: 1480px; }
    .left-narrow{ max-width: 1000px; }
    .right-map{  flex-basis: 560px; max-width: 560px; }
  }

  .surface.panel{ padding: 18px; margin-bottom: 1.25rem; }

  /* ì§€ë„ ë¼ë²¨/íŒì—… */
  .ma-label {
  position: relative;
  transform: translateY(-8px);
  padding: 4px 10px;
  border: 1px solid #b6ffe8; /* ìœ¤ê³½ì„  ìƒ‰ */
  border-radius: 999px;
  background: rgba(190, 255, 227, 0.636); /* ë°°ê²½ìƒ‰ */
  box-shadow: 0 2px 6px rgba(0, 0, 0, .10);
  font-size: 12px;
  font-weight: 450;
  color: var(--ink);
  white-space: nowrap;
  pointer-events: none;
}

.ma-iw-wrap {
  position: relative;
}

.ma-iw {
  position: relative; /* âœ… Xë²„íŠ¼ ìœ„ì¹˜ ê¸°ì¤€ */
  display: flex;
  align-items: center;
  gap: 8px;
  width: 260px;
  padding: 10px 12px;
  box-sizing: border-box;
  background: rgba(190, 255, 227, 0.890); /* ë°°ê²½ìƒ‰ */
  border: 1px solid #b6ffe8; /* ìœ¤ê³½ì„  ìƒ‰ */
  border-radius: 12px;
  box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
  overflow: hidden;
}

  /* ë²„íŠ¼ ë°•ìŠ¤ëŠ” ê·¸ëŒ€ë¡œ, ê°€ìš´ë° ì •ë ¬ */
  .ma-iw-close{
    position:absolute;
    top:6px; right:8px;   /* ë°•ìŠ¤ ìœ„ì¹˜ ê³ ì • */
    width:22px; height:22px;
    display:grid; place-items:center;
    line-height:1;
    border-radius:6px;
    border:1px solid #b6ffe8;
    background:#fff; cursor:pointer; font-weight:700;
    box-shadow:0 1px 4px rgba(0,0,0,.08);
  }

  /* ì›ë˜ ê¸€ìëŠ” ìˆ¨ê¸°ê³ , ê°€ì§œ ê¸€ìë¥¼ ì›í•˜ëŠ” ë§Œí¼ë§Œ ë¯¸ì„¸ ì´ë™ */
  .ma-iw-close { color: transparent; }         /* ì› ê¸€ì ìˆ¨ê¹€ */
  .ma-iw-close::before{
    content: 'Ã—';
    color: #000;
    position: relative;
    top: -0.3px;   /* â†‘ ìœ„ë¡œ : ìˆ˜ì¹˜ë§Œ ë°”ê¿”ì„œ ë¯¸ì„¸ì¡°ì • */
    left: -3.4px;  /* â† ì™¼ìª½ : ìˆ˜ì¹˜ë§Œ ë°”ê¿”ì„œ ë¯¸ì„¸ì¡°ì • */
  }
  .ma-iw-link{
    text-decoration:none; 
    color:inherit; 
    cursor:pointer; 
    display:flex; 
    align-items:center; 
    gap:8px; 
    width:100%;
    /* âœ… ì˜¤ë²„ë ˆì´ ì•ˆì—ì„œ í´ë¦­ ë§‰í˜ ë°©ì§€ */
    pointer-events:auto;
  }
  .ma-iw-thumb{ width:80px; height:80px; flex:0 0 80px; border-radius:8px; background:#f1f1f1; object-fit:cover; display:block; }
  .ma-iw .txt{ min-width:0; flex:1 1 auto; }
  .ma-iw .name{ font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--ink); }
  .ma-iw .date{ color:var(--muted); font-size:12px; margin-bottom:6px; }
  /* âœ… 'ìì„¸íˆ ë³´ê¸°' í…ìŠ¤íŠ¸ë„ í™•ì‹¤íˆ í´ë¦­ë˜ë„ë¡ */
  .ma-iw .more{ font-size:12px; text-decoration:underline; color: var(--brand-ink); pointer-events:auto; }



  .ma-hitbox{ width:96px; height:96px; transform: translate(-50%, -50%); border-radius:9999px; pointer-events:auto; background: transparent; }

  /* í˜ì´ì§€ë„¤ì´ì…˜ */
  .purple-pagination{
    display:inline-flex; align-items:center; gap:2px; background:#f5efff; border-radius:12px; padding:4px; border:1px solid #e4d9ff;
  }
  .purple-pagination .pg-btn{
    min-width:36px; height:36px; line-height:36px; text-align:center; border-radius:8px; cursor:pointer; user-select:none;
    padding:0 10px; font-weight:600; color:#4c3c88; background:transparent; border:none;
  }
  .purple-pagination .pg-btn:hover{ background:#efe7ff; }
  .purple-pagination .active{ background:var(--brand); color:#fff; }
  .purple-pagination .disabled{ opacity:.4; pointer-events:none; }

  #subSelect.no-sub { pointer-events: none; background-color: #fff; opacity: 1; color: #6c757d; }

  .btn-found, .btn-lost{ 
    font-weight: 550;
  display: flex;                /* ê°€ìš´ë° ì •ë ¬ */
  flex-direction: column;       /* ì¤„ë°”ê¿ˆ */
  justify-content: center;      /* ì„¸ë¡œ ê°€ìš´ë° */
  align-items: center;          /* ê°€ë¡œ ê°€ìš´ë° */
  min-height: 180px;            /* ì„¸ë¡œ í¬ê¸° â†‘ */
  text-align: center;           /* í…ìŠ¤íŠ¸ ì¤‘ì•™ */
  line-height: 1.4; 
  font-size: 1.0rem;
  }

  .btn-found small,
  .btn-lost small {
    font-size: 0.95rem;       /* ê´„í˜¸ ì•ˆ ê¸€ì”¨ í¬ê¸° */
  }


/* ì—¬ê¸° ì•„ë˜ì— ë¶™ì´ë©´ ë¨ */
  /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ë©”íƒ€(ë‚ ì§œ/ì¥ì†Œ) */
  .meta-line{
    display:flex; align-items:center; justify-content:center;
    gap:6px; color:#6c757d; font-size:.875rem; margin-bottom:.25rem;
  }
  .meta-line i{ font-size:.95rem; line-height:1; }
</style>

{% endblock %}

{% block content %}
<div class="container-xxl page-container px-4 mt-2 position-relative">
  <h4 class="text-center mb-4 fw-bold" style="font-size: 24px;">MeetAgain</h4>

  <div class="layout-row">
    <!-- ì¢Œì¸¡: ê²€ìƒ‰ + ëª©ë¡ -->
    <div class="left-narrow">
      <!-- âœ… id ì¶”ê°€: searchPanel -->
      <div id="searchPanel" class="surface panel soft-shadow">
        <div class="section-header">
          <span class="section-chip">ğŸ” ìŠµë“ë¬¼ ê²€ìƒ‰</span>
        </div>
        <form id="searchForm" method="get" action="{% url 'meetagain:index' %}">
          <div class="row g-2">
            <!-- 1ì¤„: ì¢…ë¥˜ + ì„¸ë¶€ì˜µì…˜ -->
            <div class="col-md-6">
              <label class="form-label">ì¢…ë¥˜</label>
              <select name="category" id="typeSelect" class="form-select">
                <option value="">ì¢…ë¥˜ ì„ íƒ</option>
                {% for cat, cat_label in items.model.CATEGORY_CHOICES %}
                  <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat_label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ì„¸ë¶€ì˜µì…˜</label>
              <select name="subcategory" id="subSelect" class="form-select"
                      data-subselected="{{ request.GET.subcategory|default:'' }}">
                <option value="">ì„¸ë¶€ì˜µì…˜ ì„ íƒ</option>
              </select>
            </div>

            <!-- 2ì¤„: ê¸°ê°„ -->
            <div class="col-md-12">
              <label class="form-label">ìŠµë“ ê¸°ê°„</label>
              <div class="d-flex gap-2">
                <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
                <span class="align-self-center">~</span>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
              </div>
            </div>

            <!-- 3ì¤„: ì¥ì†Œ -->
            <div class="col-md-12">
              <label class="form-label">ìŠµë“ ì¥ì†Œ</label>
              <select name="location" class="form-select">
                <option value="">ì¥ì†Œ ì„ íƒ</option>
                {% for value, label in location_choices %}
                  <option value="{{ value }}" {% if request.GET.location == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- 4ì¤„: ë¬¼í’ˆëª… -->
            <div class="col-md-12">
              <label class="form-label">ìŠµë“ë¬¼ëª…</label>
              <input type="text" name="name" value="{{ request.GET.name }}" class="form-control" placeholder="ì˜ˆ: íŒŒë€ìƒ‰ ìš°ì‚°">
            </div>

            <div class="col-12 text-end mt-2">
              <button type="submit" class="btn btn-primary px-4">ê²€ìƒ‰</button>
            </div>
          </div>
        </form>
      </div>

      <div class="surface panel">
        <div class="section-header">
          <span class="section-chip">ğŸ“‹ ë“±ë¡ëœ ìŠµë“ë¬¼ ë¦¬ìŠ¤íŠ¸</span>
          <span class="text-muted small">ìŠµë“ëœ ë‚ ì§œ ìˆœ</span>
        </div>
        <div class="row row-cols-1 row-cols-md-3 g-4 mb-3" id="items"></div>
        <div class="d-flex justify-content-center mb-1">
          <div id="pager" class="purple-pagination"></div>
        </div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ì§€ë„ + CTA -->
    <div class="right-map">
      <div class="surface soft-shadow" style="padding: 12px;">
        <!-- ê¸°ë³¸ 380px, JSê°€ ê²€ìƒ‰íŒ¨ë„ ë†’ì´ë¡œ ë®ì–´ì”€ -->
        <div id="map" style="width:100%; height:380px; border-radius:12px;"></div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <a href="{% url 'meetagain:found_register' %}" class="btn btn-found px-5 py-5 w-50 flex-fill">
          ğŸ“¥ ë¬¼ê±´ì„ ì£¼ì› ì–´ìš”!<br><small>(ìŠµë“ë¬¼ ë“±ë¡)</small>
        </a>
        <a href="{% url 'meetagain:lost_register' %}" class="btn btn-lost px-5 py-5 w-50 flex-fill">
          ğŸ“¤ ë¬¼ê±´ì„ ìƒì–´ë²„ë ¸ì–´ìš”..<br><small>(ë¶„ì‹¤ë¬¼ ì‹ ê³ )</small>
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* ì „ì—­ ìœ í‹¸: XSS ë°©ì§€ */
  function escapeHtml(s){
    if (s == null) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  const SUB_OPTIONS = {
    'ì¹´ë“œ': [], 'ì§€ê°‘': [],
    'ì „ìê¸°ê¸°': ['íƒœë¸”ë¦¿','ìŠ¤ë§ˆíŠ¸ì›Œì¹˜','ë¬´ì„ ì´ì–´í°','ì¹´ë©”ë¼','í—¤ë“œì…‹','ê¸°íƒ€ìš©í’ˆ'],
    'ì˜ë¥˜': ['ëª¨ì','ì‹ ë°œ','ì•„ìš°í„°','ê¸°íƒ€ì˜ë¥˜'],
    'ê°€ë°©': [], 'ì‹ ë°œ': [], 'ë¬¸ì„œ/ì„œë¥˜': [],
    'ê·€ê¸ˆì†': ['ë°˜ì§€','ëª©ê±¸ì´','ê·€ê±¸ì´','ì‹œê³„','ê¸°íƒ€'],
    'ì•…ê¸°': [], 'ì±…/ë…¸íŠ¸': [], 'ìŠ¤í¬ì¸  ìš©í’ˆ': [],
    'ì‹ ë¶„ì¦': [], 'í˜„ê¸ˆ': [], 'ê¸°íƒ€': []
  };

  function fillSubOptions(categoryLabel, selectedValue){
    const sub = document.getElementById('subSelect');
    const list = SUB_OPTIONS[categoryLabel] || [];
    sub.innerHTML = '';
    if (list.length === 0){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ì„¸ë¶€ì˜µì…˜ ì—†ìŒ';
      sub.appendChild(opt);
      sub.classList.add('no-sub');
      sub.value = '';
      return;
    }
    sub.classList.remove('no-sub');
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'ì„¸ë¶€ì˜µì…˜ ì„ íƒ';
    sub.appendChild(ph);
    list.forEach(v=>{
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      sub.appendChild(o);
    });
    sub.value = (selectedValue && list.includes(selectedValue)) ? selectedValue : '';
  }

  function currentCategoryLabel(){
    const sel = document.getElementById('typeSelect');
    if (!sel) return '';
    return sel.options[sel.selectedIndex]?.text?.trim() || '';
  }

  const MAX_NAME_LEN = 8;
  const LABEL_SHOW_LEVEL = 3;
  const truncateName = (s,n=MAX_NAME_LEN)=>!s?'':(s.length>n? s.slice(0,n)+'â€¦':s);

  /* âœ… ê²€ìƒ‰íŒ¨ë„ ë†’ì´ì™€ ì§€ë„ ë†’ì´ ë™ê¸°í™” */
  function syncMapHeight(){
    const sp = document.getElementById('searchPanel');
    const mapEl = document.getElementById('map');
    if (!sp || !mapEl) return;
    const h = Math.max(300, Math.round(sp.getBoundingClientRect().height)); // ìµœì†Œ 300 ìœ ì§€
    if (mapEl.style.height !== h + 'px'){
      mapEl.style.height = h + 'px';
      // ì¹´ì¹´ì˜¤ë§µ ë¦¬ë ˆì´ì•„ì›ƒ ë° ì„¼í„° ìœ ì§€
      if (window._maMap){
        const center = window._maMap.getCenter();
        window._maMap.relayout();
        window._maMap.setCenter(center);
      }
    }
  }

  // ë¦¬ì‚¬ì´ì¦ˆ ë””ë°”ìš´ìŠ¤
  let _rzTimer = null;
  window.addEventListener('resize', ()=>{
    clearTimeout(_rzTimer);
    _rzTimer = setTimeout(syncMapHeight, 120);
  });

  window.addEventListener('load', function () {
    const subSelected = document.getElementById('subSelect').dataset.subselected || '';
    fillSubOptions(currentCategoryLabel(), subSelected);

    document.getElementById('typeSelect').addEventListener('change', function(){
      fillSubOptions(currentCategoryLabel(), '');
      // ê²€ìƒ‰í¼ ë†’ì´ ë³€ë™ ê°€ëŠ¥ -> ì§€ë„ ë†’ì´ ë‹¤ì‹œ ë§ì¶¤
      setTimeout(syncMapHeight, 0);
    });

    // í°íŠ¸/ë ˆì´ì•„ì›ƒ ì ìš© í›„ í•œ ë²ˆ ë”
    syncMapHeight();
    setTimeout(syncMapHeight, 100);
    setTimeout(syncMapHeight, 400);

    initMap();
    fetchPage(1);
  });

  function initMap(){
    const container = document.getElementById('map');
    if (!container || !window.kakao || !kakao.maps) return;

    const DEFAULT_CENTER = new kakao.maps.LatLng(37.591360, 127.021961);
    const map = new kakao.maps.Map(container, { center: DEFAULT_CENTER, level: 2, maxLevel: 5 });
    window._maMap = map; // âœ… ì „ì—­ ë³´ê´€

    let openOverlay = null;

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape' && openOverlay) { openOverlay.setMap(null); openOverlay = null; }
    });
    kakao.maps.event.addListener(map, 'rightclick', () => {
      if (openOverlay) { openOverlay.setMap(null); openOverlay = null; }
    });

    const markers = [], labels = [], hitboxes = [];

    const queryString = window.location.search;
    fetch(`/meetagain/api/items${queryString}`)
      .then(res => res.json())
      .then(({ items }) => {
        if (!items || items.length === 0) return;
        const bounds = new kakao.maps.LatLngBounds();
        const detailUrlTemplate = `{% url 'meetagain:found_detail' item_id=0 %}`;

        items.forEach(item => {
          if (item.lat == null || item.lng == null) return;

          const pos = new kakao.maps.LatLng(item.lat, item.lng);
          bounds.extend(pos);

          const marker = new kakao.maps.Marker({ position: pos, map, clickable: true });
          markers.push(marker);

          const labelEl = document.createElement('div');
          labelEl.className = 'ma-label';
          labelEl.textContent = truncateName(item.name);

          const label = new kakao.maps.CustomOverlay({
            position: pos,
            content: labelEl,
            xAnchor: 0.5,   // âœ… ê°€ë¡œ ê¸°ì¤€: ê°€ìš´ë°
            yAnchor: 1.8,   // âœ… ì„¸ë¡œ ê¸°ì¤€: ì•„ë˜ìª½(í•€ ê¼­ì§€ì )
            zIndex: 2
          });
          labels.push(label);

          const detailUrl = detailUrlTemplate.replace('/0/', `/${item.id}/`);
          const thumb = item.thumbnail_url
            ? `<img src="${item.thumbnail_url}" alt="" class="ma-iw-thumb"
                    onerror="this.onerror=null; this.src='https://via.placeholder.com/80x80?text=%20';">`
            : `<div class="ma-iw-thumb"></div>`;

          const wrap = document.createElement('div');
          wrap.className = 'ma-iw-wrap';
          wrap.innerHTML = `
            <div class="ma-iw">
              <button class="ma-iw-close" title="ë‹«ê¸°">Ã—</button>
              <a class="ma-iw-link" href="${detailUrl}">
                ${thumb}
                <div class="txt">
                  <div class="name">${escapeHtml(item.name || '')}</div>
                  <div class="date">${item.date || ''}</div>
                  <span class="more">ìì„¸íˆ ë³´ê¸° â†’</span>
                </div>
              </a>
            </div>
          `;

          /* ğŸš« ê¸°ì¡´ì— ë„£ì—ˆë˜ ë°•ìŠ¤ ì „ì²´ í´ë¦­ í•¸ë“¤ëŸ¬(iw.addEventListener('click', ...))ëŠ” ì§€ì›Œì¤˜ */

          /* âœ… ë§í¬/ìì„¸íˆë³´ê¸°ì— â€œë‹¤ì¤‘ ì´ë²¤íŠ¸â€ë¡œ ê°•ì œ ë„¤ë¹„ê²Œì´ì…˜ */
          const linkEl = wrap.querySelector('.ma-iw-link');
          const moreEl = wrap.querySelector('.more');

          function goDetail(e){
            // ì¼ë¶€ ë¸Œë¼ìš°ì €/ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ê¸°ë³¸ë™ì‘ì„ ë§‰ì•„ë„ ëš«ê¸° ìœ„í•´ ë‹¤ì¤‘ ì²˜ë¦¬
            try { e.preventDefault(); } catch (_) {}
            e.stopPropagation();
            const href = linkEl.getAttribute('href') || detailUrl;

            // iOS/Safari ë° Kakao Overlay íŠ¹ìˆ˜ì¼€ì´ìŠ¤ íšŒí”¼ìš©
            setTimeout(() => { window.location.assign(href); }, 0);
            return false;
          }

          // í´ë¦­ ë¿ ì•„ë‹ˆë¼ pointer/mouse/touch ê¹Œì§€ ëª¨ë‘ ê±¸ì–´ë‘ 
          ['click','pointerdown','mousedown','touchstart'].forEach(evt => {
            linkEl.addEventListener(evt, goDetail, { passive: false });
            moreEl.addEventListener(evt, goDetail, { passive: false });
          });

          const overlay = new kakao.maps.CustomOverlay({
            position: pos, content: wrap, yAnchor: 1.1, zIndex: 9999
          });



          wrap.querySelector('.ma-iw-close').onclick = (e) => {
            e.stopPropagation(); overlay.setMap(null);
            if (openOverlay === overlay) openOverlay = null;
          };

          function openCard(){
            if (openOverlay) { openOverlay.setMap(null); openOverlay = null; }
            overlay.setMap(map); openOverlay = overlay;
          }
          kakao.maps.event.addListener(marker, 'click', openCard);

          const hitEl = document.createElement('div');
          hitEl.className = 'ma-hitbox';
          hitEl.title = 'ìì„¸íˆ ë³´ê¸°';
          hitEl.onclick = function(e){ e.stopPropagation(); openCard(); };

          const hitbox = new kakao.maps.CustomOverlay({
            position: pos, content: hitEl, xAnchor: 0.5, yAnchor: 0.5, zIndex: 10
          });
          hitbox.setMap(map); hitboxes.push(hitbox);
        });

        if (!bounds.isEmpty()) map.setBounds(bounds);

        const proj = map.getProjection();
        const targets = markers.map((m, idx) => ({
          pos: m.getPosition(),
          open: () => kakao.maps.event.trigger(markers[idx], 'click')
        }));
        kakao.maps.event.addListener(map, 'click', function(mouseEvent){
          const clickPt = proj.containerPointFromCoords(mouseEvent.latLng);
          let best = null, bestD = Infinity;
          for (const t of targets){
            const pt = proj.containerPointFromCoords(t.pos);
            const dx = pt.x - clickPt.x, dy = pt.y - clickPt.y;
            const d = Math.hypot(dx, dy);
            if (d < bestD){ bestD = d; best = t; }
          }
          const R = 48;
          if (best && bestD <= R){ best.open(); }
        });

        function toggleLabelsByZoom(){
          const lv = map.getLevel();
          if (lv <= 3){ labels.forEach(l => { if (!l.getMap()) l.setMap(map); }); }
          else { labels.forEach(l => { if (l.getMap()) l.setMap(null); }); }
        }
        toggleLabelsByZoom();
        kakao.maps.event.addListener(map, 'zoom_changed', toggleLabelsByZoom);

        // ë°ì´í„° ë¡œë“œ í›„ì—ë„ í•œ ë²ˆ ë” ë†’ì´ ì‹±í¬
        setTimeout(syncMapHeight, 0);
      })
      .catch(err => console.error('í•€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', err));
  }

  /* ë¦¬ìŠ¤íŠ¸ (6ê°œ ìœ ì§€) */
  const GRID  = document.getElementById('items');
  const PAGER = document.getElementById('pager');

  function buildQuery(extra={}) {
    const params = new URLSearchParams(window.location.search);
    for (const [k,v] of Object.entries(extra)) params.set(k, v);
    return params.toString() ? `?${params.toString()}` : '';
  }

  function fetchPage(page){
    fetch(`/meetagain/found/list_api/${buildQuery({page})}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        renderGrid(data.items);
        renderPager(data.page, data.total_pages);
      })
      .catch(err => {
        console.error('ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        GRID.innerHTML = `<p class="text-danger">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.</p>`;
      });
  }

  function renderGrid(items){
    const detailUrlTemplate = "{% url 'meetagain:found_detail' item_id=0 %}";
    GRID.innerHTML = items.map(it => {
      const detailUrl = detailUrlTemplate.replace('/0/', `/${it.id}/`);
      const name = escapeHtml(it.name);
      const loc  = escapeHtml(it.found_location || '');
      const date = it.found_date || '';
      const img  = it.image_url
        ? `<img src="${it.image_url}" alt="${name}" class="thumb">`
        : `<img src="https://via.placeholder.com/640x420?text=%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%86%EC%9D%8C" class="thumb" alt="ì´ë¯¸ì§€ ì—†ìŒ">`;

      return `
        <div class="col">
          <a class="text-decoration-none" href="${detailUrl}">
            <div class="card lost-card h-100 hoverable">
              ${img}
              <div class="card-body">
                <p class="text-center fw-bold text-dark mb-1">${name}</p>

                <div class="meta-line">
                  <i class="fa-regular fa-calendar"></i>
                  <span>${date}</span>
                </div>

                <div class="meta-line">
                  <i class="fa-solid fa-location-dot"></i>
                  <span>${loc}</span>
                </div>
              </div>
            </div>
          </a>
        </div>
      `;
    }).join('') || `<p class="text-muted m-2">ë“±ë¡ëœ ìŠµë“ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }




    function renderPager(current, total){
      if (total <= 1){ PAGER.innerHTML = ''; return; }
      let html = '';
      const prevClass = (current > 1) ? 'pg-btn' : 'pg-btn disabled';
      const nextClass = (current < total) ? 'pg-btn' : 'pg-btn disabled';
      html += `<button class="${prevClass}" data-pg="${current-1}">&laquo;</button>`;
      for (let p = 1; p <= total; p++){
        html += `<button class="pg-btn ${p===current?'active':''}" data-pg="${p}">${p}</button>`;
      }
      html += `<button class="${nextClass}" data-pg="${current+1}">&raquo;</button>`;
      PAGER.innerHTML = html;
      PAGER.querySelectorAll('.pg-btn:not(.disabled)').forEach(btn=>{
        btn.onclick = () => fetchPage(parseInt(btn.dataset.pg, 10));
      });
    }

  // ì´ˆê¸° í•œ ë²ˆ ë” ë™ê¸°í™”(ì¹´ì¹´ì˜¤ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© íƒ€ì´ë° ëŒ€ë¹„)
  syncMapHeight();
</script>
{% endblock %} 
