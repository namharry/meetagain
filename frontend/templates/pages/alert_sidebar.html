<!-- alert_sidebar.html -->
<div id="alertSidebar"
     data-open="0"
     style="
       position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
       background: #fff; box-shadow: -2px 0 5px rgba(0,0,0,.2);
       padding: 20px; z-index: 1060; transition: right .3s ease-in-out;
     "
     aria-hidden="true" role="complementary">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">ğŸ”” ì•Œë¦¼</h5>
    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="toggleSidebar()">ë‹«ê¸°</button>
  </div>

  <p class="text-muted">í‚¤ì›Œë“œë¥¼ ë“±ë¡í•˜ê³  ì•Œë¦¼ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
  <button class="btn btn-danger btn-sm mb-3" type="button" onclick="toggleKeywordInput()">í‚¤ì›Œë“œ ë“±ë¡í•˜ê¸°</button>

  <div id="keywordInputGroup" style="display:none;">
    <input type="text" id="keywordInput" class="form-control mb-2" placeholder="ì˜ˆ: ì•„ì´íŒ¨ë“œ, í…€ë¸”ëŸ¬">
    <button id="keywordAddBtn" class="btn btn-outline-secondary btn-sm mb-2" type="button" onclick="addKeywordToDB()">ì¶”ê°€</button>
  </div>


  <div id="keywordList" class="mb-3"></div>
  <hr>
  <div id="alertList" style="max-height: 300px; overflow-y:auto;">
    {% if notifications %}
      <ul>
        {% for n in notifications %}
          <li>
            [{{ n.created_at|date:"Y-m-d H:i" }}] í‚¤ì›Œë“œ '{{ n.keyword }}' ê´€ë ¨ ì•Œë¦¼
            {% if n.is_read %}(ì½ìŒ){% else %}(ì½ì§€ ì•ŠìŒ){% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ë°›ì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>
</div>

<script>
  // CSRF í† í° ì¿ í‚¤ì—ì„œ ì½ê¸° (Django CSRF ë³´í˜¸ìš©)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // ì„œë²„ì—ì„œ í‚¤ì›Œë“œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadKeywords() {
    console.log("loadKeywords() ì‹¤í–‰ë¨");
    fetch('/meetagain/keywords/')
      .then(res => {
        console.log("í‚¤ì›Œë“œ ëª©ë¡ ì‘ë‹µ ìƒíƒœ:", res.status);
        return res.json();
      })
      .then(data => {
        console.log("ë°›ì€ í‚¤ì›Œë“œ ë°ì´í„°:", data);
        const keywordList = document.getElementById('keywordList');
        keywordList.innerHTML = '';
        if (!data.keywords || data.keywords.length === 0) {
          keywordList.innerHTML = '<p>ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        data.keywords.forEach(word => {
          const pill = document.createElement('span');
          pill.className = 'badge rounded-pill text-bg-light me-1 mb-1';
          pill.textContent = word;

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn btn-sm btn-link text-danger ms-1 p-0';
          removeBtn.textContent = 'Ã—';

          // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í‚¤ì›Œë“œ ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ
          removeBtn.onclick = () => {
            // ì„œë²„ì— ì‚­ì œ ìš”ì²­ ë³´ë‚´ê³  ì„±ê³µí•˜ë©´ pill ì œê±°í•˜ëŠ” ë¡œì§ ì¶”ê°€ í•„ìš”
            deleteKeywordFromDB(word);
            pill.remove();
          };

          pill.appendChild(removeBtn);
          keywordList.appendChild(pill);
        });
      })
      .catch(error => {
        console.error("í‚¤ì›Œë“œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      });
  }



  // í‚¤ì›Œë“œ ë“±ë¡ ìš”ì²­
  function addKeywordtoDB() {
    console.log("addKeywordtoDB() ì‹¤í–‰ë¨");
    const csrftoken = getCookie('csrftoken');
    console.log("CSRF Token:", csrftoken);

    const input = document.getElementById('keywordInput');
    const word = input.value.trim();
    if (!word) {
      alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    fetch('/meetagain/keywords/add/', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken,
      },
      body: new URLSearchParams({ word: word }),
    })
    .then(response => {
      if (response.ok) {
        input.value = '';
        loadKeywords();
        alert(`'${word}' í‚¤ì›Œë“œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } else {
        alert('í‚¤ì›Œë“œ ë“±ë¡ ì‹¤íŒ¨');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('í‚¤ì›Œë“œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // DOMContentLoaded ì´ë²¤íŠ¸ëŠ” í•¨ìˆ˜ ë°–ì—ì„œ í•œ ë²ˆë§Œ ë“±ë¡
  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('keywordAddBtn');
    if (addBtn) {
      addBtn.addEventListener('click', addKeywordtoDB);
    }
  });

  // ì„œë²„ì—ì„œ ì•Œë¦¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadNotifications() {
    fetch('/meetagain/notifications/')
      .then(res => res.json())
      .then(data => {
        const alertList = document.getElementById('alertList');
        alertList.innerHTML = '';

        if (!data.notifications || data.notifications.length === 0) {
          alertList.innerHTML = '<p>ë°›ì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const divListGroup = document.createElement('div');
        divListGroup.className = 'list-group';

        data.notifications.forEach(n => {
          if (n.content_type !== 'founditem') return;

          const a = document.createElement('a');
          a.href = `/meetagain/found/${n.object_id}/`;
          a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';

          // ì™¼ìª½ ì œëª©
          const titleSpan = document.createElement('span');
          titleSpan.textContent = n.item_name || `(ì œëª© ì—†ìŒ)`;

          // ì˜¤ë¥¸ìª½ ì½ìŒ/ì½ì§€ ì•ŠìŒ ë°°ì§€
          const statusBadge = document.createElement('span');
          statusBadge.className = n.is_read ? 'badge bg-secondary' : 'badge bg-danger';
          statusBadge.textContent = n.is_read ? 'ì½ìŒ' : 'ì½ì§€ ì•ŠìŒ';

          a.appendChild(titleSpan);
          a.appendChild(statusBadge);
          divListGroup.appendChild(a);

          // í´ë¦­ ì‹œ ì½ìŒ ì²˜ë¦¬ í›„ ì´ë™
          a.addEventListener('click', function(e) {
            e.preventDefault(); // ê¸°ë³¸ ì´ë™ ë§‰ìŒ
            fetch(`/meetagain/notifications/read/${n.id}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken'),
              }
            })
              .then(res => {
                if (res.ok) {
                  statusBadge.className = 'badge bg-secondary';
                  statusBadge.textContent = 'ì½ìŒ';
                  window.location.href = `/meetagain/found/${n.object_id}/`;
                }
              })
              .catch(console.error);
          });
        });

        alertList.appendChild(divListGroup);
      })
      .catch(console.error);
  }

  // Django CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }




</script>
