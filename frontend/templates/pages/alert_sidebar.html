<!-- alert_sidebar.html -->
<div id="alertSidebar"
     data-open="0"
     style="
       position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
       background: #fff; box-shadow: -2px 0 5px rgba(0,0,0,.2);
       padding: 20px; z-index: 1060; transition: right .3s ease-in-out;
     "
     aria-hidden="true" role="complementary">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">🔔 알림</h5>
    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="toggleSidebar()">닫기</button>
  </div>

  <p class="text-muted">키워드를 등록하고 알림을 받아보세요.</p>
  <button class="btn btn-danger btn-sm mb-3" type="button" onclick="toggleKeywordInput()">키워드 등록하기</button>

  <div id="keywordInputGroup" style="display:none;">
    <input type="text" id="keywordInput" class="form-control mb-2" placeholder="예: 아이패드, 텀블러">
    <button id="keywordAddBtn" class="btn btn-outline-secondary btn-sm mb-2" type="button" onclick="addKeywordToDB()">추가</button>
  </div>


  <div id="keywordList" class="mb-3"></div>
  <hr>
  <div id="alertList" style="max-height: 300px; overflow-y:auto;">
    {% if notifications %}
      <ul>
        {% for n in notifications %}
          <li>
            [{{ n.created_at|date:"Y-m-d H:i" }}] 키워드 '{{ n.keyword }}' 관련 알림
            {% if n.is_read %}(읽음){% else %}(읽지 않음){% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>받은 알림이 없습니다.</p>
    {% endif %}
  </div>
</div>

<script>
  // CSRF 토큰 쿠키에서 읽기 (Django CSRF 보호용)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // 서버에서 키워드 목록 불러오기
function loadKeywords() {
  console.log("loadKeywords() 실행됨");
  fetch('/meetagain/keywords/')
    .then(res => {
      console.log("키워드 목록 응답 상태:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("받은 키워드 데이터:", data);
      const keywordList = document.getElementById('keywordList');
      keywordList.innerHTML = '';
      if (!data.keywords || data.keywords.length === 0) {
        keywordList.innerHTML = '<p>등록된 키워드가 없습니다.</p>';
        return;
      }
      const ul = document.createElement('ul');
      data.keywords.forEach(word => {
        const li = document.createElement('li');
        li.textContent = word;
        ul.appendChild(li);
      });
      keywordList.appendChild(ul);
    })
    .catch(error => {
      console.error("키워드 목록 불러오기 오류:", error);
    });
}


  // 키워드 등록 요청
  function addKeywordtoDB() {
    console.log("addKeywordtoDB() 실행됨");
    const csrftoken = getCookie('csrftoken');
    console.log("CSRF Token:", csrftoken);

    const input = document.getElementById('keywordInput');
    const word = input.value.trim();
    if (!word) {
      alert('키워드를 입력해주세요.');
      return;
    }

    fetch('/meetagain/keywords/add/', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken,
      },
      body: new URLSearchParams({ word: word }),
    })
    .then(response => {
      if (response.ok) {
        input.value = '';
        loadKeywords();
        alert(`'${word}' 키워드가 등록되었습니다.`);
      } else {
        alert('키워드 등록 실패');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('키워드 등록 중 오류가 발생했습니다.');
    });
  }

  // DOMContentLoaded 이벤트는 함수 밖에서 한 번만 등록
  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('keywordAddBtn');
    if (addBtn) {
      addBtn.addEventListener('click', addKeywordtoDB);
    }
  });

  // 서버에서 알림 목록 불러오기
  function loadNotifications() {
    fetch('/meetagain/notifications/')
      .then(res => res.json())
      .then(data => {
        const alertList = document.getElementById('alertList');
        alertList.innerHTML = '';
        if (!data.notifications || data.notifications.length === 0) {
          alertList.innerHTML = '<p>받은 알림이 없습니다.</p>';
          return;
        }
        const ul = document.createElement('ul');
        data.notifications.forEach(n => {
          const li = document.createElement('li');
          li.textContent = `[${n.created_at}] 키워드 '${n.keyword}' 관련 알림 ${n.is_read ? '(읽음)' : '(읽지 않음)'}`;
          ul.appendChild(li);
        });
        alertList.appendChild(ul);
      })
      .catch(console.error);
  }

</script>
