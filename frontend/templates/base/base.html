{% load static %} 
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}MeetAgain{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts: Noto Sans KR -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300..900&display=swap" rel="stylesheet">

  <!-- Bootstrap, FontAwesome, Custom CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">

  <!-- Kakao Map -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f387153e7e5f423d38f1a6d392d6bef8&libraries=services"></script>

  <!-- ===== Theme & Layout Polishing ===== -->
  <style>
    :root{
      --brand: #713ed6;
      --brand-ink: #4c3c88;
      --mint: #A8E5D8;
      --mint-weak: #E6FAF5;
      --ink: #222;
      --muted: #666;
      --card: #ffffff;
      --border: #e9eef4;
      --bg-1: #F9FAFB;
      --bg-2: #F3F7FB;
    }

    html, body { height: 100%; }
    body{
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: radial-gradient(1200px 800px at 20% -10%, #f1f5ff 0%, var(--bg-1) 55%) fixed;
      color: var(--ink);
    }

    /* 공통 카드 스타일 */
    .surface{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(22, 28, 45, 0.05);
    }
    .soft-shadow{ box-shadow: 0 10px 24px rgba(17, 24, 39, .08); }

    /* 섹션 타이틀 칩 */
    .chip{
      display:inline-flex; align-items:center; gap:.5rem;
      background: #eef2ff; color: var(--brand-ink);
      border: 1px solid #e0e7ff;
      padding: .35rem .7rem; border-radius: 9999px; font-weight: 600; font-size:.9rem;
    }

    /* 폼/컨트롤 미세 정리 */
    .form-label{ font-weight:600; color:#334155; }
    .form-control, .form-select{
      border-radius: 10px; border-color: var(--border);
    }
    .form-control:focus, .form-select:focus{
      box-shadow: 0 0 0 .25rem rgba(123, 63, 242, .12);
      border-color: #c8b3ff;
    }

    /* 버튼 통일 */
    .btn-primary{
      background: var(--brand); border-color: var(--brand);
    }
    .btn-primary:hover{ filter: brightness(.95); }

    /* 상단 우측 아이콘 */
    #topIcons i { color:#2b2b2b; }
    #topIcons i:hover{ color: var(--brand); }

    /* 메인 CTA 버튼(우측 카드) */
    .btn-found {
      background-color: #ebf0ff;
      color: #000000;
      border: 1px solid #dfe5ff;
      border-radius: 14px;
      font-weight: 700;
    }
    .btn-found:hover { background-color: #dde5ff; }
    .btn-lost {
      background-color: #f5ebff;
      color: #000000;
      border: 1px solid #eaddff;
      border-radius: 14px;
      font-weight: 700;
    }
    .btn-lost:hover { background-color: #e8d9ff; }

    /* 카드 호버 */
    .card.hoverable{
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card.hoverable:hover{
      transform: translateY(-4px);
      box-shadow: 0 10px 28px rgba(0,0,0,.12);
    }

    /* 목록 카드(이미지) 기본값 */
    .lost-card .thumb {
      width: 100%; height: 180px; object-fit: cover; display: block;
      border-top-left-radius: .75rem; border-top-right-radius: .75rem;
      background: #f6f6f6;
    }
    .lost-card .card-body { min-height: 96px; }

    /* 사이드바 알림 항목 */
    #alertSidebar .list-group-item {
      border: 1px solid #ddd;
      background-color: white;
      margin-bottom: 4px;
      border-radius: 8px;
      padding: 10px 15px;
    }

    /* 컨테이너 상단 여백 살짝 축소 */
    .container-fluid.mt-4{ margin-top: 1.25rem !important; }
  </style>

  {% block extra_head %}{% endblock %}
  {% block extra_css %}{% endblock %}
</head>
<body>

<div class="container-fluid mt-4 position-relative">

  {% if request.path != '/users/login/' and request.path != '/users/signup/' and request.path != '/users/password_reset/' %}
  <div id="topIcons" class="top-icons d-flex justify-content-end gap-3" style="position: fixed; top: 20px; right: 20px; font-size: 20px; z-index: 1100;">
    <i class="fa-solid fa-bell position-relative" onclick="toggleSidebar()" style="cursor:pointer;">
      <span id="notificationBadge" 
            style="position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: red; border-radius: 50%; display: none;"></span>
    </i>
    <i class="fa-solid fa-bars" onclick="toggleMenuSidebar()" style="cursor:pointer;"></i>
  </div>
  {% endif %}

  {% include "pages/menu_sidebar.html" %}
  {% include "pages/alert_sidebar.html" %}

  {% if messages %}
    <div class="container mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% block content %}{% endblock %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

<script>
  // 알림 사이드바 토글 (오른쪽)
  window.toggleSidebar = function () {
    const el = document.getElementById('alertSidebar');
    const icons = document.getElementById('topIcons');
    if (!el || !icons) return;

    const isOpen = el.dataset.open === '1';
    const newOpenState = isOpen ? '0' : '1';
    el.style.right = newOpenState === '1' ? '0' : '-400px';
    el.dataset.open = newOpenState;

    icons.style.setProperty('display', newOpenState === '1' ? 'none' : 'flex', 'important');

    if (newOpenState === '1') {
      el.removeAttribute('aria-hidden');
      el.removeAttribute('inert');
      
      fetch('/meetagain/notifications/mark_read/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      })
      .then(res => {
        if (res.ok) {
          setNotificationBadge(false);
          loadKeywords();
          loadNotifications();  // 한 번만 호출
        }
      })
      .catch(console.error);
    } else {
      el.setAttribute('aria-hidden', 'true');
      el.setAttribute('inert', '');
    }
  };

  // 메뉴 사이드바 토글 (오른쪽)
  window.toggleMenuSidebar = function () {
    const el = document.getElementById('menuSidebar');
    const icons = document.getElementById('topIcons');
    if (!el || !icons) return;

    const isOpen = el.dataset.open === '1';
    const newOpenState = isOpen ? '0' : '1';
    el.style.right = newOpenState === '1' ? '0' : '-300px';
    el.dataset.open = newOpenState;

    icons.style.setProperty('display', newOpenState === '1' ? 'none' : 'flex', 'important');

    if (newOpenState === '1') {
      el.removeAttribute('aria-hidden');
      el.removeAttribute('inert');
    } else {
      el.setAttribute('aria-hidden', 'true');
      el.setAttribute('inert', '');
    }
  };

  // 알림 사이드바 내 키워드 입력 토글
  window.toggleKeywordInput = function () {
    const g = document.getElementById('keywordInputGroup');
    if (!g) return;
    g.style.display = (g.style.display === 'none' || !g.style.display) ? 'block' : 'none';
  };

</script>

{% block extra_scripts %}{% endblock %}
{% block script %}{% endblock %}
</body>
</html>
